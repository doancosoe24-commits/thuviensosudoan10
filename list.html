<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="./img/logo1.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh sách</title>
  <style>
    html, body { margin:0; height:100%; font-family: Arial,sans-serif; background:#f7f9fb; color:#333; }
    body { display:flex; flex-direction:column; width:70%; margin:0 auto; }
    main { flex:1; padding:20px 0; }
    .item_list { display:flex; align-items:center; margin-bottom:18px; }
    .arrow { width:120px;height:45px;background:#ccae6e; clip-path: polygon(0% 0%,78% 0%,100% 50%,78% 100%,0% 100%,18% 50%); display:flex; align-items:center; justify-content:center; font-weight:700; color:#8c6d2a; margin-right:12px; }
    .item { background:#004aad; flex:1; display:flex; flex-direction:column; padding:10px 5px; color:#fff; border-radius:5px; box-shadow:0 3px 6px rgba(0,0,0,0.15); cursor:pointer; }
    .item p { margin:0 0 6px 0; font-weight:700; font-size:16px; }
    .btn-new { background:#ff3131; color:#ffde59; font-weight:700; border:none; padding:8px 16px; border-radius:10px; align-self:flex-end; cursor:pointer; font-size:12px; transition:0.2s; }
    .back-link { color:#ccae6e; padding:10px; font-weight:600; text-decoration:underline; cursor:pointer; display:inline-block; }
    @media(max-width:768px){ body{width:95%;} .arrow{width:50px;height:35px;font-size:11px;} .item p{font-size:12px;} .btn-new{padding:6px 12px;font-size:11px;} }
    /* Bộ lọc */
    .filter-box {
      background: #ffffff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }

    .filter-box select,
    .filter-box button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      cursor: pointer;
      background: #ffffff;
      transition: 0.2s;
    }

    .filter-box button {
      background: #004aad;
      color: #fff;
      border: none;
      font-weight: 600;
    }

    .filter-box button:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>

<div id="header"></div>

<main>
  <span class="back-link" onclick="history.back()">Quay lại</span>
  <h2 id="pageTitle" style="text-align:center;color:#ccae6e;text-transform:uppercase;"></h2>
       <div class="filter-box">
      <select id="filterCategory">
        <option value="">-- Loại văn bản --</option>
      </select>
      <select id="filterPublisher">
        <option value="">-- Cơ quan ban hành --</option>
      </select>

      <button id="btnAll">Hiển thị TẤT CẢ</button>
    </div>

  <div id="list"></div>
</main>
<div id="footer"></div>

<script>
  function loadHTML(id, url) {
  fetch(url)
    .then(res => res.text())
    .then(html => {
      document.getElementById(id).innerHTML = html;

      // Nếu load header thì gắn sự kiện search
      if(id === "header"){
        const searchBtn = document.getElementById("searchBtn");
        const searchInput = document.getElementById("searchInput");
        if(searchBtn && searchInput){
          searchBtn.addEventListener("click", ()=>{
            const key = searchInput.value.trim();
            if(!key) return;
            window.location.href = `timkiem.html?key=${encodeURIComponent(key)}`;
          });

          // Nhấn Enter cũng search
          searchInput.addEventListener("keyup", e=>{
            if(e.key === "Enter") searchBtn.click();
          });
        }
      }
    })
    .catch(err => console.error(err));
}
const webAppUrl = "https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec";
const ref = window.location.origin;
const slugURL = new URLSearchParams(window.location.search).get("slug")?.trim();

function toSlug(text){
  return text
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9\s-]/g, "")
    .trim()
    .replace(/\s+/g, "-");
}

let DATA = [];   // <-- Lưu toàn bộ dữ liệu
let FILTERED = []; // <-- Sau khi lọc category qua slug

async function loadPage(){
  try{
    const [headerHTML, footerHTML, data] = await Promise.all([
      fetch("header.html").then(r=>r.ok?r.text():""),
      fetch("footer.html").then(r=>r.ok?r.text():""),
      fetch(`${webAppUrl}?ref=${encodeURIComponent(ref)}`).then(r=>r.json())
    ]);

    DATA = data;

    document.getElementById("header").innerHTML = headerHTML;
    document.getElementById("footer").innerHTML = footerHTML;

    // Lọc theo slug category từ URL
    FILTERED = DATA.filter(i => String(i.slug).trim() === slugURL);

    const pageTitle = document.getElementById("pageTitle");
    pageTitle.textContent = FILTERED.length ? FILTERED[0].category : "Không có dữ liệu";

    // --- TẠO DỮ LIỆU CHO BỘ LỌC ---
    loadFilterOptions(FILTERED);

    // Render lần đầu
    renderList(FILTERED);

    // Gán sự kiện lọc
    attachFilterEvents();

  }catch(err){
    console.error(err);
    document.getElementById("list").textContent = "Không thể tải dữ liệu";
  }
}

/* ====================================
   LOAD DỮ LIỆU VÀO SELECT BOX
   ==================================== */
function loadFilterOptions(data){
  const categorySelect = document.getElementById("filterCategory");
  const publisherSelect = document.getElementById("filterPublisher");

  // Lấy unique loại văn bản
  const types = [...new Set(data.map(i => i.loaivanban).filter(x => x))];

  types.forEach(t=>{
    const op = document.createElement("option");
    op.value = t.trim();
    op.textContent = t.trim();
    categorySelect.appendChild(op);
  });

  // Lấy unique nơi ban hành
  const pubs = [...new Set(data.map(i => i.noibanhanh).filter(x => x))];

  pubs.forEach(p=>{
    const op = document.createElement("option");
    op.value = p.trim();
    op.textContent = p.trim();
    publisherSelect.appendChild(op);
  });
}

/* ====================================
   GÁN SỰ KIỆN LỌC
   ==================================== */
function attachFilterEvents(){
  const categorySelect = document.getElementById("filterCategory");
  const publisherSelect = document.getElementById("filterPublisher");
  const btnAll = document.getElementById("btnAll");

  categorySelect.addEventListener("change", applyFilter);
  publisherSelect.addEventListener("change", applyFilter);
  btnAll.addEventListener("click", ()=>{
    categorySelect.value = "";
    publisherSelect.value = "";
    renderList(FILTERED);
  });
}

/* ====================================
   ÁP DỤNG LỌC
   ==================================== */
function applyFilter(){
  const cat = document.getElementById("filterCategory").value.trim();
  const pub = document.getElementById("filterPublisher").value.trim();

  let result = FILTERED;

  if(cat) result = result.filter(i => i.loaivanban === cat);
  if(pub) result = result.filter(i => i.noibanhanh === pub);

  renderList(result);
}

/* ====================================
   HIỂN THỊ DANH SÁCH
   ==================================== */
function renderList(data){
  const listEl = document.getElementById("list");
  listEl.innerHTML = "";

  if(data.length === 0){
    listEl.textContent = "Không có dữ liệu phù hợp.";
    return;
  }

  const frag = document.createDocumentFragment();

  data.forEach(item=>{
    const itemList = document.createElement("div");
    itemList.className="item_list";

    const arrow = document.createElement("div");
    arrow.className="arrow";

    const itemDiv = document.createElement("div");
    itemDiv.className="item";
    itemDiv.dataset.title = item.title;

    const p = document.createElement("p");
    p.textContent = item.title;

    const btn = document.createElement("button");
    btn.className="btn-new";
    btn.textContent = "Có hiệu lực";

    itemDiv.appendChild(p);
    itemDiv.appendChild(btn);

    itemList.appendChild(arrow);
    itemList.appendChild(itemDiv);

    frag.appendChild(itemList);
  });

  listEl.appendChild(frag);

  // click mở chi tiết
  listEl.onclick = e=>{
    const itemDiv = e.target.closest(".item");
    if(itemDiv){
      const slug = toSlug(itemDiv.dataset.title);
      window.location.href = `detail.html?slug=${slug}`;
    }
  };
}

loadPage();
</script>


</body>
</html>
