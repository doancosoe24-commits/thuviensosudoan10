<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
<title>Kết quả tìm kiếm</title>

<style>
:root{
  --primary:#004aad;
  --gold:#ccae6e;
  --bg:#f6f8fb;
  --card:#ffffff;
  --text:#1f2937;
  --radius:16px;
  --shadow:0 10px 25px rgba(0,0,0,0.08);
}

*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  font-family:"Segoe UI",Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

body{
  display:flex;
  flex-direction:column;
  width:75%;
  margin:0 auto;
}

main{
  flex:1;

}

/* TITLE */
#pageTitle{
  text-align:center;
  color:#fff;
  background:var(--primary);
  font-size:20px;
  font-weight:800;
  letter-spacing:1px;
  margin:0 0 30px;
  padding:10px;
  border-radius:10px;
}
.keyword{color:#ffde59}

/* RESULTS */
#results{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:22px;
}

.item{
  background:linear-gradient(135deg,var(--primary),#003a8c);
  border-radius:var(--radius);
  padding:22px 18px;
  color:var(--gold);
  cursor:pointer;
  box-shadow:var(--shadow);
  transition:.3s;
}
.item:hover{
  transform:translateY(-6px) scale(1.02);
  box-shadow:0 18px 35px rgba(0,0,0,.18);
  color:#fff;
}

.item p{
  margin:0 0 12px;
  font-size:16px;
  font-weight:700;
}

.status{
  display:inline-block;
  padding:6px 14px;
  border-radius:999px;
  background:rgba(255,255,255,.15);
  color:#fff;
  font-size:12px;
  font-weight:700;
}

/* LOADING */
#loadingBox{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:60px 0;
  color:var(--primary);
  font-weight:600;
}

.loader{
  width:52px;
  height:52px;
  border:4px solid rgba(0,0,0,.1);
  border-top-color:var(--gold);
  border-radius:50%;
  animation:spin .7s linear infinite;
  margin-bottom:14px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* RESPONSIVE */
@media(max-width:1024px){ body{width:90%} }
@media(max-width:768px){
  body{width:100%}
  #results{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="header"></div>
<main>
  <h2 id="pageTitle">
    TỪ KHÓA: <span class="keyword" id="searchKey"></span>
  </h2>

  <!-- LOADING -->
  <div id="loadingBox">
    <div class="loader"></div>
    Đang tra dữ liệu...
  </div>

  <!-- RESULTS -->
  <div id="results" style="display:none"></div>
</main>
<div id="footer"></div>
<script src="main.js"></script>
<script>
/* ========== CONFIG ========== */
const webAppUrl = "https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec";

/* ========== DOM ========== */
const loadingBox = document.getElementById("loadingBox");
const results = document.getElementById("results");
const searchKeyEl = document.getElementById("searchKey");

/* ========== PARAM ========== */
const params = new URLSearchParams(location.search);
const key = (params.get("key") || "").trim();
searchKeyEl.textContent = key || "KHÔNG CÓ";

/* ========== UTIL ========== */
function escapeHtml(str){
  return String(str||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

/**
 * Chuẩn hoá để so sánh tìm kiếm:
 * - chuyển Unicode sang NFD rồi loại dấu (accent)
 * - chuyển 'đ' -> 'd'
 * - loại bỏ ký tự không phải chữ/số/khoảng trắng
 * - đưa về chữ thường
 */
function normalizeSearch(text){
  return String(text||"")
    .normalize("NFD")                       // tách dấu
    .replace(/[\u0300-\u036f]/g, "")        // xoá dấu
    .replace(/đ/g, "d").replace(/Đ/g, "D")  // đ -> d
    .replace(/[^0-9a-zA-Z\s]/g, " ")        // giữ chữ, số, space
    .replace(/\s+/g, " ")                   // gộp nhiều space
    .trim()
    .toLowerCase();
}

/* ========== UI HELPERS ========== */
function showLoading(){
  loadingBox.style.display="flex";
  results.style.display="none";
}

function hideLoading(){
  loadingBox.style.display="none";
  results.style.display="grid";
}

/* ========== LOAD & FILTER ========== */
async function loadAndFilter(){
  showLoading();

  results.innerHTML = ""; // clear trước khi hiển thị kết quả

  if(!key){
    hideLoading();
    results.innerHTML="<p style='text-align:center'>Không có từ khóa.</p>";
    return;
  }

  try{
    const res = await fetch(webAppUrl).then(r=>r.json());
    const items = res?.ThuVienPhapLuatSo || res?.data?.ThuVienPhapLuatSo || [];

    // chuẩn hoá từ khoá và tách thành các từ con (support multi-word search)
    const normalizedKey = normalizeSearch(key);
    const keyParts = normalizedKey.split(" ").filter(Boolean); // các từ tìm kiếm

    const filtered = items.filter(i => {
      if(!i.title) return false;
      const normalizedTitle = normalizeSearch(i.title);

      // tất cả từ trong keyParts phải xuất hiện trong tiêu đề (AND search).
      // Nếu bạn muốn OR search (một trong các từ), đổi every -> some
      const matched = keyParts.every(part => normalizedTitle.includes(part));

      return matched;
    });

    hideLoading();

    if(!filtered.length){
      results.innerHTML="<p style='text-align:center'>Không tìm thấy kết quả.</p>";
      return;
    }

    filtered.forEach(i=>{
      const div=document.createElement("div");
      div.className="item";
      // giữ slug dạng không dấu cho detail link
      const slug = normalizeSearch(i.title).replace(/\s+/g, "-");
      div.dataset.slug = slug;
      div.innerHTML=`
        <p>${escapeHtml(i.title)}</p>
        <span class="status">Có hiệu lực</span>
      `;
      div.onclick=()=>location.href=`detail.html?slug=${div.dataset.slug}`;
      results.appendChild(div);
    });

  }catch(err){
    console.error("Lỗi API:", err);
    hideLoading();
    results.innerHTML="<p>Không thể tải dữ liệu.</p>";
  }
}

loadAndFilter();
</script>


</body>
</html>
