<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
      <link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
  <title>Admin - Qu·∫£n l√Ω Users</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --accent:#0b6cff;
      --muted:#6b7280;
      --radius:14px;
      --shadow:0 10px 30px rgba(15,23,42,0.08);
      --danger:#ef4444;
      --success:#10b981;
      --max-width:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{background:var(--bg); color:var(--text); margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased; padding:28px; display:flex; justify-content:center}
    .app{width:100%; max-width:var(--max-width)}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .title{font-size:28px; color:var(--accent); font-weight:700}
    .card{background:linear-gradient(180deg,var(--card),#fbfdff); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    .left{display:flex;gap:12px;align-items:center;flex:1;min-width:220px}
    .search{flex:1;min-width:180px}
    .search input{width:100%;padding:10px 14px;border-radius:12px;border:1px solid #e6e9ef;font-size:14px;background:#fff}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:14px}
    .btn-ghost{background:transparent;border:1px solid #e6e9ef}
    .btn-add{background:var(--accent);color:#fff}
    .table-wrap{border-radius:10px;overflow:auto;background:transparent}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{text-align:left;padding:12px 14px;font-size:12px;color:var(--muted);text-transform:uppercase;white-space:nowrap}
    tbody td{padding:12px 14px;border-bottom:1px solid rgba(15,23,42,0.04);font-size:14px;vertical-align:middle}
    tbody tr:hover{background:rgba(11,108,255,0.03)}
    .action-btn{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;border:none;color:#fff;cursor:pointer;font-size:13px}
    .edit{background:#f59e0b}
    .del{background:var(--danger)}
    .lock{background:#64748b}
    .role-toggle{background:#06b6d4}
    .badge{padding:6px 8px;border-radius:8px;font-size:12px;color:#fff;display:inline-block}
    .badge.admin{background:#0ea5b7}
    .badge.user{background:#60a5fa}
    .badge.locked{background:var(--danger)}
    .badge.active{background:var(--success)}
    .badge.inactive{background:var(--muted)}
    .canview{font-size:12px;color:#374151;display:inline-block;padding:6px 8px;border-radius:8px;border:1px dashed #e6e9ef;background:#fff;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .small{font-size:12px;color:var(--muted)}
    .readonly { background:#f3f4f6 !important; }
    /* popup modal */
    .popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:999}
    .form{background:#fff;padding:18px;border-radius:12px;width:min(560px,94%);box-shadow:var(--shadow);animation:pop .18s ease;max-height:86vh;overflow:auto}
    @keyframes pop{from{transform:translateY(-10px);opacity:0}to{transform:translateY(0);opacity:1}}
    .form h3{margin:0 0 10px;color:var(--accent)}
    .form .row{margin-bottom:10px}
    .form input, .form select, .form textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
    .form .muted{font-size:12px;color:var(--muted)}
    .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 16px;border-radius:10px;display:none;z-index:10000}
    .toast.show{display:block}
    /* responsive: convert rows to card-list for small widths */
    @media (max-width:820px){
      table{min-width:0}
      thead{display:none}
      tbody td{display:block;padding:12px 10px;border-bottom:1px solid rgba(15,23,42,0.04)}
      tbody tr{display:block;margin-bottom:12px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:10px;padding:10px}
      tbody td:before{content:attr(data-label);display:block;font-weight:600;color:var(--muted);font-size:12px;margin-bottom:6px}
      .canview{max-width:100%}
    }
    @media (max-width:420px){
      body{padding:12px}
      .title{font-size:30px;text-align: center;}
      .form{padding:14px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">Admin ‚Äî Qu·∫£n l√Ω t√†i kho·∫£n</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="left">
          <div class="search"><input id="q" placeholder="T√¨m ki·∫øm username / email / ng√†y t·∫°o ..." aria-label="T√¨m ki·∫øm" /></div>
        </div>
        <div class="controls">
          <button id="btnReload" class="btn btn-ghost">‚ü≥ T·∫£i l·∫°i</button>
          <button id="btnAdd" class="btn btn-add">+ Th√™m t√†i kho·∫£n</button>
        </div>
      </div>

      <div class="table-wrap">
        <table aria-describedby="user-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Active</th>
              <th>Can View</th>
              <th>Kh√≥a</th>
              <th>Ng√†y t·∫°o</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="tb">
            <tr><td colspan="9" style="text-align:center;padding:18px">Ch∆∞a t·∫£i d·ªØ li·ªáu...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- popup form -->
  <div id="popup" class="popup" aria-hidden="true">
    <div class="form" role="dialog" aria-modal="true">
      <h3 id="ftitle">Th√™m user</h3>

      <input id="fid" type="hidden" />
      <div class="row"><input id="fusername_inp" placeholder="Username" /></div>
      <div class="row"><input id="femail_inp" placeholder="Email" /></div>
      <div class="row"><input id="fpassword_inp" placeholder="M·∫≠t kh·∫©u (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)" /></div>
      <div class="row">
        <select id="frole_inp">
          <option value="user">user</option>
          <option value="admin">admin</option>
          <option value="editor">editor</option>
        </select>
      </div>
      <div class="row">
        <label style="display:flex;gap:10px;align-items:center">
          <input id="factive_inp" type="checkbox" />
          <span>Active (k√≠ch ho·∫°t)</span>
        </label>
      </div>

      <hr />
      <div class="row small">Ph√¢n quy·ªÅn xem t√†i li·ªáu cho user n√†y:</div>
      <div class="row" style="margin-bottom:6px">
        <label style="display:flex;gap:8px;align-items:center;">
          <input id="fcanview_all" type="checkbox" />
          <span>Allow view <strong>ALL</strong> documents (all)</span>
        </label>
      </div>
      <div class="row">
        <label class="small">Ho·∫∑c ch·ªçn t·ª´ng user (multiselect):</label>
        <select id="fcanview_select" multiple size="6" style="min-height:120px"></select>
        <div class="small" style="margin-top:6px;color:#475569">Ch·ªçn nh·ªØng user m√† <em>t√†i kho·∫£n n√†y</em> ƒë∆∞·ª£c ph√©p xem t√†i li·ªáu c·ªßa h·ªç. N·∫øu kh√¥ng ch·ªçn v√† kh√¥ng b·∫≠t "ALL" th√¨ ch·ªâ xem t√†i li·ªáu g√°n tr·ª±c ti·∫øp cho id n√†y.</div>
      </div>

      <div style="text-align:right;margin-top:10px">
        <button id="saveBtn" class="btn btn-add">L∆∞u</button>
        <button id="cancelBtn" class="btn btn-ghost">H·ªßy</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ================= CONFIG ================= */
    // Thay URL Apps Script n·∫øu c·∫ßn
    const API = "https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec";

    /* L·∫§Y TOKEN T·ª™ localStorage */
    const rawUser = localStorage.getItem("loggedInUser");
    if(!rawUser){ alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p"); window.location.href = "/login.html"; }
    let token = "";
    let currentRole = "";
    let currentUserId = "";
    try{
      const parsed = JSON.parse(rawUser);
      token = parsed.token || (parsed.user && parsed.user.token) || parsed.accessToken || "";
      if(parsed.user){ currentRole = parsed.user.role || currentRole; currentUserId = parsed.user.id || currentUserId; }
      if(!currentRole && token){ const p = parseTokenPayload(token); currentRole = (p && p.role) ? p.role : currentRole; currentUserId = (p && p.id) ? p.id : currentUserId; }
    }catch(e){ console.error(e); localStorage.removeItem("loggedInUser"); alert("Token kh√¥ng h·ª£p l·ªá, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i."); window.location.href = "/login.html"; }
    if(!currentRole){ alert("Kh√¥ng x√°c ƒë·ªãnh role. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i."); localStorage.removeItem("loggedInUser"); window.location.href = "/login.html"; }
    const roleLower = String(currentRole).toLowerCase();
    if(roleLower !== 'admin' && roleLower !== 'editor'){ alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã."); window.location.href = "/login.html"; }

    /* elements */
    const tb = document.getElementById('tb');
    const popup = document.getElementById('popup');
    const toast = document.getElementById('toast');
    const btnAdd = document.getElementById('btnAdd');
    const btnReload = document.getElementById('btnReload');
    const fid = document.getElementById('fid');
    const fusername = document.getElementById('fusername_inp');
    const femail = document.getElementById('femail_inp');
    const fpassword = document.getElementById('fpassword_inp');
    const frole = document.getElementById('frole_inp');
    const factive = document.getElementById('factive_inp');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const qInput = document.getElementById('q');
    const fcanview_all = document.getElementById('fcanview_all');
    const fcanview_select = document.getElementById('fcanview_select');

    let allUsersCache = [];

    /* helpers */
    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); toast.style.display='block'; setTimeout(()=>{ toast.style.display='none'; toast.classList.remove('show'); }, 2600); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; }); }
    function formatDate(v){ if(!v) return ''; const n = Number(v); if(!isNaN(n) && n > 1000){ const d = new Date(n); return d.toLocaleString(); } const d = new Date(v); if(!isNaN(d)) return d.toLocaleString(); return v; }
    function isLocked(lock_until){ const n = Number(lock_until)||0; return n && Date.now() < n; }

    function parseTokenPayload(t){ try{ if(!t || t.indexOf('.')<0) return null; const body = t.split('.')[0]; let s = body.replace(/-/g,'+').replace(/_/g,'/'); while(s.length % 4) s += '='; const json = atob(s); return JSON.parse(json); }catch(e){ return null; } }

    function parseCanViewString(s){ if(!s) return []; if(typeof s === 'string' && s.trim().toLowerCase()==='all') return ['all']; return String(s).split(',').map(x=>x.trim()).filter(x=>x!==''); }
    function resolveCanViewText(s){ if(!s) return '-'; const arr = parseCanViewString(s); if(arr.length===0) return '-'; if(arr.indexOf('all')>=0) return 'all'; const names = arr.map(id => { const u = allUsersCache.find(x=>String(x.id)===String(id)); return u ? (u.username||u.email||id) : id; }); if(names.length>3) return `${names.length} users`; return names.join(', '); }
    function canViewTooltip(s){ if(!s) return ''; const arr = parseCanViewString(s); if(arr.indexOf('all')>=0) return 'Allowed: ALL'; return arr.map(id => { const u = allUsersCache.find(x=>String(x.id)===String(id)); return u ? `${u.username} (${u.id})` : id; }).join('\n'); }

    /* ================= LOAD DATA ================= */
    async function load(){
      tb.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:18px">ƒêang t·∫£i...</td></tr>`;
      try{
        let users = [];
        const roleL = String(currentRole).toLowerCase();

        if(roleL === 'admin'){
          const body = new URLSearchParams({ route:'users-list', token });
          const res = await fetch(API, { method:'POST', body });
          const json = await res.json();
          if(!json || json.status !== 'success'){ tb.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:18px">L·ªói khi l·∫•y danh s√°ch</td></tr>`; showToast(json && json.message ? json.message : 'L·ªói'); return; }
          users = json.data || [];
        } else {
          const res = await fetch(API, { method:'GET', cache:'no-store' });
          const json = await res.json();
          if(!json || json.status !== 'success'){ tb.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:18px">Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu</td></tr>`; showToast('L·ªói khi l·∫•y d·ªØ li·ªáu'); return; }
          users = (json.data && json.data.Users) ? json.data.Users : [];
        }

        allUsersCache = users.slice();
        populateCanViewOptions();

        if(!users || users.length === 0){ tb.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:18px">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; return; }

        tb.innerHTML = users.map(it => {
          const locked = isLocked(it.lock_until);
          const activeBadge = (String(it.active) === '1' || String(it.active).toLowerCase() === 'true') ? `<span class=\"badge active\">Active</span>` : `<span class=\"badge inactive\">Inactive</span>`;
          const roleLowerIt = String(it.role||'').toLowerCase();
          const roleBadge = (roleLowerIt === 'admin') ? `<span class=\"badge admin\">Admin</span>` : (roleLowerIt === 'editor' ? `<span class=\"badge user\">Editor</span>` : `<span class=\"badge user\">User</span>`);
          const canViewCell = `<div class=\"canview\" title=\"${escapeHtml(canViewTooltip(it.can_view))}\">${escapeHtml(resolveCanViewText(it.can_view))}</div>`;
          const safeJson = escapeHtml(JSON.stringify(it));
          return `<tr data-id=\"${escapeHtml(it.id)}\">\n            \n            <td data-label=\"Username\">${escapeHtml(it.username || '')}</td>\n            <td data-label=\"Email\">${escapeHtml(it.email || '')}</td>\n            <td data-label=\"Role\">${roleBadge}</td>\n            <td data-label=\"Active\">${activeBadge}</td>\n            <td data-label=\"Can View\">${canViewCell}</td>\n            <td data-label=\"Kh√≥a\">${locked ? `<span class=\\\"badge locked\\\">Kh√≥a t·ªõi ${formatDate(it.lock_until)}</span>` : (it.failed_login ? `<small>Failed:${it.failed_login}</small>` : '-')}</td>\n            <td data-label=\"Ng√†y t·∫°o\">${formatDate(it.created_at)}</td>\n            <td data-label=\"H√†nh ƒë·ªông\">\n              <button class=\"action-btn edit\" data-id=\"${escapeHtml(it.id)}\" data-json='${safeJson}'>‚úè S·ª≠a</button>\n              ${roleL === 'admin' ? `<button class=\"action-btn lock\" data-id=\"${escapeHtml(it.id)}\" data-locked=\"${locked}\" data-lock=\"${escapeHtml(it.lock_until||'0')}\">${locked ? 'üîì M·ªü' : 'üîí Kh√≥a'}</button>` : ''}\n              ${roleL === 'admin' ? `<button class=\"action-btn role-toggle\" data-id=\"${escapeHtml(it.id)}\" data-role=\"${escapeHtml(it.role||'user')}\">${(String(it.role).toLowerCase()==='admin') ? '‚áÑ Thay User' : '‚áÑ Thay Admin'}</button>` : ''}\n              ${roleL === 'admin' ? `<button class=\"action-btn del\" data-id=\"${escapeHtml(it.id)}\">üóë X√≥a</button>` : ''}\n            </td>\n          </tr>`;
        }).join('');

        attachRowListeners();
      }catch(err){ console.error(err); tb.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:18px">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`; showToast('L·ªói t·∫£i d·ªØ li·ªáu'); }
    }

    function populateCanViewOptions(){ fcanview_select.innerHTML = ''; allUsersCache.forEach(u => { const opt = document.createElement('option'); opt.value = u.id || ''; opt.textContent = (u.username || u.email || u.id); fcanview_select.appendChild(opt); }); }

    function attachRowListeners(){ document.querySelectorAll('.action-btn.edit').forEach(b => { b.onclick = ()=>{ let obj = {}; try{ obj = JSON.parse(b.getAttribute('data-json')); }catch(e){ obj = { id: b.dataset.id }; } openEditForm(obj); }; });
      if(String(currentRole).toLowerCase() === 'admin'){
        document.querySelectorAll('.action-btn.lock').forEach(b=>{ b.onclick = async ()=> { const id = b.dataset.id; const currentlyLocked = (b.getAttribute('data-locked') === 'true'); await toggleLock(id, currentlyLocked); }; });
        document.querySelectorAll('.action-btn.role-toggle').forEach(b=>{ b.onclick = async ()=> { const id = b.dataset.id; const role = b.getAttribute('data-role') || 'user'; await toggleRole(id, role); }; });
        document.querySelectorAll('.action-btn.del').forEach(b=>{ b.onclick = async ()=> { const id = b.dataset.id; if(!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a user n√†y?')) return; await deleteUser(id); }; });
      }
    }

    function openEditForm(item = {}){
      const isAdmin = String(currentRole).toLowerCase() === 'admin';
      document.getElementById('ftitle').textContent = item && item.id ? 'S·ª≠a user' : 'Th√™m user';
      fid.value = item.id || '';
      fusername.value = item.username || '';
      femail.value = item.email || '';
      fpassword.value = '';
      frole.value = item.role || 'user';
      factive.checked = (String(item.active) === '1' || String(item.active).toLowerCase() === 'true');

      fcanview_all.checked = false;
      Array.from(fcanview_select.options).forEach(o=> o.selected = false);
      if(item && item.can_view){ const s = item.can_view; if(String(s).trim().toLowerCase() === 'all') fcanview_all.checked = true; else { const arr = parseCanViewString(s); arr.forEach(id => { const opt = fcanview_select.querySelector(`option[value="${id}"]`); if(opt) opt.selected = true; }); } }

      if(!isAdmin){ fusername.setAttribute('disabled','disabled'); fusername.classList.add('readonly'); femail.setAttribute('disabled','disabled'); femail.classList.add('readonly'); fpassword.setAttribute('disabled','disabled'); fpassword.classList.add('readonly'); frole.setAttribute('disabled','disabled'); frole.classList.add('readonly'); factive.setAttribute('disabled','disabled'); fcanview_all.setAttribute('disabled','disabled'); Array.from(fcanview_select.options).forEach(o=> o.setAttribute('disabled','disabled')); saveBtn.style.display = 'none'; } else { fusername.removeAttribute('disabled'); fusername.classList.remove('readonly'); femail.removeAttribute('disabled'); femail.classList.remove('readonly'); fpassword.removeAttribute('disabled'); fpassword.classList.remove('readonly'); frole.removeAttribute('disabled'); frole.classList.remove('readonly'); factive.removeAttribute('disabled'); fcanview_all.removeAttribute('disabled'); Array.from(fcanview_select.options).forEach(o=> o.removeAttribute('disabled')); saveBtn.style.display = ''; }

      popup.style.display = 'flex'; popup.setAttribute('aria-hidden','false'); }

    cancelBtn.onclick = ()=> { popup.style.display='none'; popup.setAttribute('aria-hidden','true'); };

    saveBtn.onclick = async ()=>{ const isAdmin = String(currentRole).toLowerCase() === 'admin'; if(!isAdmin){ showToast('Ch·ªâ admin m·ªõi c√≥ th·ªÉ l∆∞u thay ƒë·ªïi'); return; } const id = fid.value; const route = id ? 'users-update' : 'users-add'; const username = fusername.value.trim(); const email = femail.value.trim(); const password = fpassword.value.trim(); const role = frole.value; const active = factive.checked ? 1 : 0; if(!username || !email){ showToast('Username v√† email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng'); return; } let can_view_val = ''; if(fcanview_all.checked) can_view_val = 'all'; else { const sel = Array.from(fcanview_select.selectedOptions).map(o=>o.value).filter(v=>v); can_view_val = sel.join(','); } const payload = new URLSearchParams(); payload.append('route', route); payload.append('token', token); if(id) payload.append('id', id); payload.append('username', username); payload.append('email', email); payload.append('role', role); payload.append('active', String(active)); if(password) payload.append('password', password); payload.append('can_view', can_view_val); try{ const res = await fetch(API, { method:'POST', body: payload }); const json = await res.json(); if(json && (json.status === 'success' || json.id)){ showToast(json.message || 'L∆∞u th√†nh c√¥ng'); popup.style.display='none'; await load(); } else { showToast(json && json.message ? json.message : 'L·ªói khi l∆∞u'); } }catch(err){ console.error(err); showToast('L·ªói l∆∞u d·ªØ li·ªáu'); } };

    async function toggleLock(id, currentlyLocked){ const isAdmin = String(currentRole).toLowerCase() === 'admin'; if(!isAdmin){ showToast('Ch·ªâ admin m·ªõi thao t√°c ƒë∆∞·ª£c'); return; } const willLock = !currentlyLocked; if(willLock && !confirm('Kh√≥a t√†i kho·∫£n n√†y trong 20 nƒÉm?')) return; const lockUntil = willLock ? (Date.now() + 20 * 365 * 24 * 60 * 60 * 1000) : 0; const payload = new URLSearchParams(); payload.append('route','users-update'); payload.append('token', token); payload.append('id', id); payload.append('lock_until', String(lockUntil)); try{ const res = await fetch(API, { method:'POST', body: payload }); const json = await res.json(); showToast(json.message || (willLock ? 'ƒê√£ kh√≥a' : 'ƒê√£ m·ªü kh√≥a')); await load(); }catch(err){ console.error(err); showToast('L·ªói khi kh√≥a/m·ªü kh√≥a'); } }

    async function toggleRole(id, currentRole){ const isAdmin = String(currentRole).toLowerCase() === 'admin'; if(!isAdmin){ showToast('Ch·ªâ admin m·ªõi thao t√°c ƒë∆∞·ª£c'); return; } const target = (String(currentRole).toLowerCase() === 'admin') ? 'user' : 'admin'; if(!confirm(`Chuy·ªÉn role c·ªßa user n√†y th√†nh "${target}"?`)) return; const payload = new URLSearchParams(); payload.append('route','users-update'); payload.append('token', token); payload.append('id', id); payload.append('role', target); try{ const res = await fetch(API, { method:'POST', body: payload }); const json = await res.json(); showToast(json.message || 'ƒê√£ c·∫≠p nh·∫≠t role'); await load(); }catch(err){ console.error(err); showToast('L·ªói khi c·∫≠p nh·∫≠t role'); } }

    async function deleteUser(id){ const isAdmin = String(currentRole).toLowerCase() === 'admin'; if(!isAdmin){ showToast('Ch·ªâ admin m·ªõi thao t√°c ƒë∆∞·ª£c'); return; } try{ const payload = new URLSearchParams({ route:'users-delete', id, token }); const res = await fetch(API, { method:'POST', body: payload }); const json = await res.json(); if(json && (json.status === 'success' || json.success)){ showToast(json.message || 'ƒê√£ x√≥a'); await load(); } else showToast(json && json.message ? json.message : 'L·ªói khi x√≥a'); }catch(err){ console.error(err); showToast('L·ªói khi x√≥a user'); } }

    btnReload.onclick = () => load();
    btnAdd.onclick = () => { if(String(currentRole).toLowerCase() !== 'admin'){ showToast('Ch·ªâ admin m·ªõi t·∫°o user m·ªõi'); return; } openEditForm({}); };

    qInput.oninput = ()=> { const q = qInput.value.trim().toLowerCase(); document.querySelectorAll('#tb tr').forEach(tr=>{ tr.style.display = (tr.innerText.toLowerCase().includes(q)) ? '' : 'none'; }); };

    document.addEventListener('keydown', (e) => { if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'u'){ e.preventDefault(); Array.from(fcanview_select.options).forEach(opt => opt.selected = false); fcanview_all.checked = false; showToast('ƒê√£ b·ªè ch·ªçn t·∫•t c·∫£ user'); } });

    load();
  </script>
</body>
</html>