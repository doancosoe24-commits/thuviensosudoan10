<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - T√†i Li·ªáu Ng√†nh (Qu·∫£n l√Ω quy·ªÅn) ‚Äî Responsive</title>
<link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#eef6ff; --card:#fff; --text:#0f172a; --accent:#0b6cff; --accent-2:#06b6d4;
  --muted:#6b7280; --radius:12px; --shadow-sm:0 8px 24px rgba(7,16,36,0.06); --shadow-lg:0 22px 60px rgba(7,16,36,0.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#f8fbff,var(--bg));color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;padding:20px}
.container{max-width:1100px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px;border-radius:14px;background:white;color:black;box-shadow:var(--shadow-lg);margin-bottom:14px}
.header .brand{display:flex;gap:12px;align-items:center}
.logo{width:52px;height:52px;border-radius:12px;background:rgba(255,255,255,0.12);display:grid;place-items:center;font-weight:800}
.header h1{margin:0;font-size:30px;color: #0b6cff;}
.header p{margin:0;font-size:13px;opacity:.95}
.user-meta{background:rgba(255,255,255,0.12);padding:8px 12px;border-radius:999px;font-weight:600;display:flex;gap:8px;align-items:center;font-size:13px;min-width:0;max-width:340px;overflow:hidden}
.card{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow-sm)}
.toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
.search{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#fbfdff,#f6f9ff);padding:8px;border-radius:12px;border:1px solid rgba(7,16,36,0.04);flex:1;min-width:220px}
.search input{border:0;background:transparent;outline:none;padding:8px;font-size:14px;width:100%}
.controls{display:flex;gap:8px}
.btn{border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:transform .12s ease;display:inline-flex;align-items:center;gap:8px}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
.btn.ghost{background:transparent;border:1px solid rgba(7,16,36,0.06);padding:8px 12px}
.btn.warn{background:#f59e0b;color:#fff}
.table-wrap{overflow:auto;border-radius:10px}
table{width:100%;border-collapse:collapse;min-width:0;table-layout:fixed}
thead th{padding:12px 14px;font-size:12px;color:var(--muted);text-transform:uppercase;text-align:left}
tbody td{padding:12px 14px;border-bottom:1px solid rgba(7,16,36,0.04);font-size:14px}
tbody tr:hover{background:linear-gradient(90deg, rgba(6,182,212,0.02), rgba(11,108,255,0.02))}
.cat-badge{display:inline-block;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,#fff,#f2fbff);color:var(--muted);font-weight:700;font-size:13px;border:1px solid rgba(11,108,255,0.06);cursor:pointer}
.name-cell .cell-inner{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;padding-right:6px}
.action-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:none;color:#fff;cursor:pointer;font-size:13px}
.action-btn.small{padding:6px 8px;font-size:12px}
.badge{padding:6px 8px;border-radius:8px;font-size:12px;color:#fff}
.badge.all{background:#10b981}
.cards{display:none}

/* ========== FORM / MODAL IMPROVEMENTS ========== */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(7,16,36,0.45);align-items:center;justify-content:center;z-index:1200;padding:20px}
.modal{background:var(--card);padding:18px;border-radius:14px;width:100%;max-width:920px;box-shadow:var(--shadow-lg);max-height:92vh;overflow:auto}
.modal .modal-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.modal .modal-title{font-size:18px;margin:0}

/* form grid */
.form .modal-body{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
.form .col{background:transparent}
.form .field{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
.field label{font-size:13px;color:var(--muted);font-weight:600}
.input, .select, .multiselect{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(7,16,36,0.08);background:#fbfdff;outline:none;font-size:14px}
.input:focus, .select:focus, .multiselect:focus{box-shadow:0 6px 18px rgba(11,108,255,0.08);border-color:rgba(11,108,255,0.22)}
.small-muted{font-size:13px;color:var(--muted)}
.row-helper{font-size:12px;color:var(--muted)}

/* multi-select nicer look on supported browsers */
.multiselect{min-height:140px;max-height:320px;overflow:auto}
.select[disabled], .input[disabled], .multiselect[disabled]{opacity:0.6}

.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}

/* group modal layout */
.group-grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
.group-list{max-height:360px;overflow:auto;border:1px solid #eef3f8;padding:10px;border-radius:10px;background:#fbfdff}
.gfile{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px dashed rgba(7,16,36,0.04)}
.gfile:last-child{border-bottom:none}
.user-select{min-height:160px;max-height:420px;overflow:auto;border:1px solid #eef3f8;padding:8px;border-radius:10px;background:#fff}

/* responsive */
@media (max-width:920px){
  .form .modal-body{grid-template-columns:1fr}
  .modal{max-width:540px;border-radius:12px;padding:12px}
}
@media (max-width:820px){
  .header h1{font-size:25px}
  .table-wrap{display:none}
  .cards{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .modal{width:100%;height:100vh;border-radius:0;max-width:100%;display:flex;flex-direction:column}
  .modal .modal-body{overflow:auto;padding-bottom:80px}
  .modal .actions{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,transparent,#fff);padding:12px;border-top:1px solid rgba(7,16,36,0.04)}
}

/* accessibility helpers */
.sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
.toast{position:fixed;left:50%;top:22px;transform:translateX(-50%);background:#071024;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:1400;max-width:90%;word-break:break-word}
.toast.show{display:block}
.loader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.6);z-index:1500}
.loader.show{display:flex}
.spinner{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#fff,#f4f7fb);display:grid;place-items:center;box-shadow:var(--shadow-sm);font-weight:700}

/* tiny helpers */
.kv{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <header class="header" role="banner" aria-label="Header qu·∫£n tr·ªã">
      <div class="brand">
        <div>
          <h1>T√†i Li·ªáu Ng√†nh</h1>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div id="meta" class="user-meta">ƒêang t·∫£i...</div>
        <button id="logoutBtn" class="btn ghost" title="ƒêƒÉng xu·∫•t">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main class="card" role="main">
      <div class="toolbar">
        <div class="search" role="search" aria-label="T√¨m ki·∫øm">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#667085" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M11 19a8 8 0 100-16 8 8 0 000 16z" stroke="#667085" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="q" placeholder="T√¨m theo danh m·ª•c / t√™n file / url / quy·ªÅn..." aria-label="T√¨m vƒÉn b·∫£n">
          <button id="clearSearch" class="btn ghost" title="X√≥a">‚úï</button>
        </div>

        <div class="controls" role="toolbar">
          <button id="btnReload" class="btn ghost" title="L√†m m·ªõi">‚ü≥</button>
          <button id="btnAdd" class="btn primary" title="Th√™m t√†i li·ªáu">+ Th√™m</button>
        </div>
      </div>

      <div class="table-wrap" aria-live="polite">
        <table role="table" aria-label="B·∫£ng t√†i li·ªáu">
          <thead>
            <tr>
              <th style="width:80px">ID</th>
              <th style="width:180px">Danh m·ª•c</th>
              <th style="width:340px">T√™n file</th>
              <th style="width:120px">URL</th>
              <th style="width:140px">Quy·ªÅn xem</th>
              <th style="width:220px"></th>
            </tr>
          </thead>
          <tbody id="tb">
            <tr><td colspan="6" style="text-align:center;padding:18px">Ch∆∞a t·∫£i d·ªØ li·ªáu...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="cards" id="cards" hidden aria-live="polite"></div>
    </main>
  </div>

  <!-- existing main popup (kept structure + improved styles) -->
  <div id="popup" class="modal-backdrop" aria-hidden="true">
    <div class="modal form" role="dialog" aria-modal="true" aria-labelledby="ftitle">
      <div class="modal-header">
        <h3 id="ftitle">Th√™m t√†i li·ªáu</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="kv">Tr·∫°ng: <span id="formState">M·ªõi</span></div>
          <button id="cancelBtnTop" class="btn ghost" aria-label="ƒê√≥ng">‚úï</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="col">
          <input id="fid" type="hidden" />

          <div class="field">
            <label for="fcategory_select">Danh m·ª•c (ch·ªçn t·ª´ danh s√°ch)</label>
            <select id="fcategory_select" class="select" aria-label="Ch·ªçn danh m·ª•c">
              <option value="">-- Ch·ªçn danh m·ª•c --</option>
            </select>
          </div>

          <div class="field">
            <label for="fname_inp">T√™n file (name)</label>
            <input id="fname_inp" class="input" placeholder="T√™n file (vd: huongdan.pdf)" />
            <div class="row-helper">T√™n bi·ªÉu di·ªÖn trong b·∫£ng; n√™n k√®m ƒëu√¥i n·∫øu c·∫ßn.</div>
          </div>

          <div class="field">
            <label for="fslug_inp">Slug (t√πy ch·ªçn)</label>
            <input id="fslug_inp" class="input" placeholder="Slug (kh√¥ng hi·ªÉn th·ªã ·ªü b·∫£ng)" />
            <div class="row-helper">N·∫øu ƒë·ªÉ tr·ªëng, h·ªá th·ªëng s·∫Ω t·ª± sinh t·ª´ danh m·ª•c.</div>
          </div>

          <div class="field">
            <label for="furl_inp">URL / ƒê∆∞·ªùng d·∫´n</label>
            <input id="furl_inp" class="input" placeholder="Link ho·∫∑c ƒë∆∞·ªùng d·∫´n n·ªôi b·ªô" />
            <div class="row-helper">H·ªó tr·ª£ http(s) ho·∫∑c ƒë∆∞·ªùng d·∫´n t·ªáp n·ªôi b·ªô.</div>
          </div>

        </div>

        <div class="col">
          <div class="field">
            <div class="small-muted"><strong>Quy·ªÅn xem</strong> ‚Äî Cho ph√©p ai xem t√†i li·ªáu n√†y</div>
          </div>

          <div class="field" style="display:flex;align-items:center;gap:10px">
            <label style="display:flex;gap:8px;align-items:center"><input id="fquyen_all" type="checkbox"> <strong>T·∫•t c·∫£</strong></label>
            <div class="small-muted">Ho·∫∑c ch·ªçn user b√™n d∆∞·ªõi (Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu)</div>
          </div>

          <div class="field">
            <label for="fquyen_select">Ch·ªçn user</label>
            <div style="display:flex;gap:8px;align-items:flex-start">
              <select id="fquyen_select" multiple class="multiselect" style="flex:1" aria-label="Ch·ªçn user"></select>
              <div style="display:flex;flex-direction:column;gap:8px">
                <button id="selectAllBtn" class="btn ghost">Ch·ªçn t·∫•t c·∫£</button>
                <button id="clearSelectBtn" class="btn ghost">B·ªè ch·ªçn</button>
              </div>
            </div>
            <div class="row-helper">Ch·ªçn user m√† t√†i kho·∫£n n√†y ƒë∆∞·ª£c ph√©p xem t√†i li·ªáu. N·∫øu b·∫≠t "T·∫•t c·∫£" th√¨ m·ªçi ng∆∞·ªùi ƒë·ªÅu xem ƒë∆∞·ª£c.</div>
          </div>

          <div class="field">
            <label class="small-muted">Xem tr∆∞·ªõc quy·ªÅn hi·ªán t·∫°i</label>
            <div id="previewQuyen" class="kv">-</div>
          </div>

          <div class="form-actions">
            <button id="saveBtn" class="btn primary">L∆∞u</button>
            <button id="cancelBtn" class="btn ghost">H·ªßy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Group-level modal (improved UI) -->
  <div id="groupPopup" class="modal-backdrop" aria-hidden="true">
    <div class="modal" id="groupForm" role="dialog" aria-modal="true" aria-labelledby="groupTitle">
      <style>
        /* Scoped styles to make group modal mobile-friendly and column-first */
        .modal#groupForm { padding:14px; max-width:740px; }
        .modal#groupForm .modal-header{gap:10px}
        .modal#groupForm .group-grid{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
        .modal#groupForm .group-list{max-height:420px;overflow:auto}
        .modal#groupForm .user-select{min-height:220px}
        .modal#groupForm .group-controls{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
        .modal#groupForm .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
        /* Mobile-first column layout */
        @media (max-width:820px){
          .modal#groupForm{width:100%;height:100vh;border-radius:0;padding:12px;display:flex;flex-direction:column}
          .modal#groupForm .modal-body{overflow:auto}
          .modal#groupForm .group-grid{grid-template-columns:1fr;gap:12px}
          .modal#groupForm .group-controls{align-items:stretch}
          .modal#groupForm .group-list{order:3}
          .modal#groupForm .mobile-header-row{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
          .modal#groupForm .sticky-actions{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg,transparent,#ffffff);border-top:1px solid rgba(7,16,36,0.04);display:flex;gap:8px;justify-content:space-between}
          .modal#groupForm .sticky-actions .left{display:flex;gap:8px}
          .modal#groupForm .group-list{max-height:38vh}
          .modal-backdrop{padding:0}
        }
      </style>

      <div class="modal-header">
        <div style="display:flex;flex-direction:column">
          <h3 id="groupTitle" class="modal-title">Quy·ªÅn nh√≥m: <span id="groupName">‚Äî</span></h3>
          <div class="kv">G√°n nhanh quy·ªÅn cho to√†n nh√≥m ho·∫∑c ch·ªçn t·ª´ng file</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="groupHelp" class="btn ghost" title="H∆∞·ªõng d·∫´n">?</button>
          <button id="closeGroupPopupTop" class="btn ghost" aria-label="ƒê√≥ng">‚úï</button>
        </div>
      </div>

      <div class="modal-body">
       

        <div class="group-grid">
          <!-- left column: user selection + quick controls -->
          <div class="group-controls">
            <div class="mobile-header-row" aria-hidden="true">
              <div class="kv">Ch·ªçn user / g√°n nhanh</div>
              <div class="kv">Nh√≥m: <strong id="groupNameSmall">‚Äî</strong></div>
            </div>

            <label class="small-muted">Ch·ªçn user</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1">
                <select id="groupUserSelect" multiple class="user-select" aria-label="Ch·ªçn user cho nh√≥m"></select>
              </div>
              <div style="width:120px;display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                <button id="groupSelectAll" class="btn ghost">Ch·ªçn t·∫•t c·∫£</button>
                <button id="groupClearAll" class="btn ghost">B·ªè ch·ªçn</button>
                <label style="display:flex;align-items:center;gap:8px"><input id="groupAllCheckbox" type="checkbox"> <span class="small-muted">G√°n "all"</span></label>
              </div>
            </div>

            <div style="margin-top:10px">
              <label class="small-muted">T√¨m user</label>
              <input id="groupUserFilter" class="input" placeholder="G√µ t√™n ho·∫∑c email ƒë·ªÉ l·ªçc" aria-label="L·ªçc user">
            </div>

            <div style="margin-top:8px">
              <div class="small-muted">G·ª£i √Ω: ch·∫°m ƒë·ªÉ ch·ªçn, gi·ªØ Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu (desktop).</div>
            </div>

          </div>

          <!-- right column: file list -->
          <div>
            <label class="small-muted">C√°c file trong nh√≥m</label>
            <div class="group-list" id="groupFileList" aria-live="polite"></div>
          </div>
        </div>

        <!-- actions: show as sticky on mobile -->
        <div class="actions" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="applyToGroupBtn" class="btn primary">√Åp d·ª•ng cho NH√ìM</button>
          <button id="applyToSelectedBtn" class="btn warn">√Åp d·ª•ng cho file ƒë√£ ch·ªçn</button>
          <button id="closeGroupPopup" class="btn ghost">ƒê√≥ng</button>
        </div>

        <div class="sticky-actions" style="display:none" id="mobileStickyActions">
          <div class="left">
            <button id="applyToSelectedBtn_mobile" class="btn warn">√Åp d·ª•ng cho file</button>
            <button id="applyToGroupBtn_mobile" class="btn primary">√Åp d·ª•ng NH√ìM</button>
          </div>
          <div class="right">
            <button id="closeGroupPopup_mobile" class="btn ghost">ƒê√≥ng</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loader" class="loader" aria-hidden="true"><div class="spinner">‚ü≥</div></div>

<script>
/* ========== CONFIG (gi·ªØ nguy√™n API n·∫øu b·∫°n d√πng Apps Script) ========== */
const API = "https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec";

/* ========== ELEMENTS ========== */
const tb = document.getElementById('tb');
const cardsRoot = document.getElementById('cards');
const popup = document.getElementById('popup');
const toast = document.getElementById('toast');
const loader = document.getElementById('loader');

const btnAdd = document.getElementById('btnAdd');
const btnReload = document.getElementById('btnReload');
const logoutBtn = document.getElementById('logoutBtn');
const clearSearch = document.getElementById('clearSearch');
const qInput = document.getElementById('q');

const fid = document.getElementById('fid');
const fcategory_select = document.getElementById('fcategory_select');
const fname_inp = document.getElementById('fname_inp');
const fslug_inp = document.getElementById('fslug_inp');
const furl_inp = document.getElementById('furl_inp');
const fquyen_all = document.getElementById('fquyen_all');
const fquyen_select = document.getElementById('fquyen_select');
const selectAllBtn = document.getElementById('selectAllBtn');
const clearSelectBtn = document.getElementById('clearSelectBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const cancelBtnTop = document.getElementById('cancelBtnTop');
const metaEl = document.getElementById('meta');
const previewQuyen = document.getElementById('previewQuyen');

/* group popup elements */
const groupPopup = document.getElementById('groupPopup');
const groupNameEl = document.getElementById('groupName');
const groupUserSelect = document.getElementById('groupUserSelect');
const groupFileList = document.getElementById('groupFileList');
const groupSelectAll = document.getElementById('groupSelectAll');
const groupClearAll = document.getElementById('groupClearAll');
const groupAllCheckbox = document.getElementById('groupAllCheckbox');
const applyToGroupBtn = document.getElementById('applyToGroupBtn');
const applyToSelectedBtn = document.getElementById('applyToSelectedBtn');
const closeGroupPopup = document.getElementById('closeGroupPopup');
const closeGroupPopupTop = document.getElementById('closeGroupPopupTop');

let session = null; let role=''; let roleLower='';
let ALL_USERS = []; let ALL_TITLES = []; let DATA = []; // loaded visible docs

/* ========== HELPERS ========== */
function showToast(msg,time=2200){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), time); }
function showLoader(on=true){ loader.style.display = on ? 'flex' : 'none'; loader.setAttribute('aria-hidden', !on); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function parseJwtPayload(t){ try{ if(!t||t.indexOf('.')<0) return null; let b=t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'); while(b.length%4) b+='='; return JSON.parse(atob(b)); }catch(e){return null;} }
function slugify(s){ if(!s) return ''; let x=String(s).replace(/ƒê/g,'D').replace(/ƒë/g,'d'); x=x.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9\s-]/g,'').trim().replace(/\s+/g,'-').toLowerCase(); return x; }
function parseQuyen(s){ if(!s) return []; if(String(s).trim().toLowerCase()==='all') return ['all']; return String(s).split(',').map(x=>x.trim()).filter(Boolean); }
function uniqArray(a){ return Array.from(new Set((a||[]).map(x=>String(x)))); }
function resolveQuyenText(q){ if(!q) return '-'; if(String(q).trim().toLowerCase()==='all') return '<span class="badge all">all</span>'; const arr=parseQuyen(q); const names = arr.map(id => { const u = ALL_USERS.find(x=>String(x.id)===String(id)); return u ? (u.username || u.email || id) : id; }); if(names.length===0) return '-'; if(names.length>3) return `${names.length} users`; return esc(names.join(', ')); }

/* ========== AUTH & INIT ========== */
function initAuthAndUI(){ const raw = localStorage.getItem('loggedInUser'); if(!raw){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p'); location.href='/login.html'; return; } try{ session = JSON.parse(raw); const tok = session.token || (session.user && session.user.token) || ''; let r = (session.user && session.user.role) || ''; if(!r && tok){ const payload = parseJwtPayload(tok); if(payload) r = payload.role || ''; } role = r||''; roleLower = String(role).toLowerCase(); const displayName = esc(session.user?.username || session.user?.email || 'Admin'); metaEl.innerHTML = `<div style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><strong>${displayName}</strong><div style="font-size:12px;color:var(--muted)">Role: ${esc(role||'')}</div></div>`; if(!role || (roleLower !== 'admin' && roleLower !== 'editor')){ alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y'); localStorage.removeItem('loggedInUser'); location.href='/login.html'; return; } if(roleLower !== 'admin' && roleLower !== 'editor'){ btnAdd.style.display = 'none'; } }catch(e){ console.error(e); localStorage.removeItem('loggedInUser'); alert('Token kh√¥ng h·ª£p l·ªá'); location.href='/login.html'; } }

/* ========== LOAD USERS ========== */
async function loadUsers(){ try{ let users=[]; if(roleLower === 'admin'){ const body = new URLSearchParams({ route:'users-list', token: session.token }); const res = await fetch(API, { method:'POST', body }); const j = await res.json(); if(j && j.status === 'success') users = j.data || []; } else { const res = await fetch(API); const j = await res.json(); users = (j && j.data && j.data.Users) ? j.data.Users : []; } ALL_USERS = users; populateUserSelects(); }catch(e){ console.error('loadUsers', e); ALL_USERS = []; populateUserSelects(); } }
function populateUserSelects(){ fquyen_select.innerHTML = ''; groupUserSelect.innerHTML = ''; ALL_USERS.forEach(u=>{ const val = u.id || u.email || u.username || ''; const label = u.username || u.email || u.id || ''; const opt1 = document.createElement('option'); opt1.value = val; opt1.textContent = label; fquyen_select.appendChild(opt1); const opt2 = document.createElement('option'); opt2.value = val; opt2.textContent = label; groupUserSelect.appendChild(opt2); }); }

/* ========== populate categories into select ========== */
function populateCategories(){ fcategory_select.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>'; ALL_TITLES.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.textContent = t; fcategory_select.appendChild(opt); }); }

/* ========== LOAD DOCUMENTS ========= */
async function loadDocs(){ tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">ƒêang t·∫£i...</td></tr>`; cardsRoot.innerHTML = ''; cardsRoot.hidden = true; showLoader(true); try{ const body = new URLSearchParams({ route:'tailieu-list', token: session.token }); const res = await fetch(API, { method:'POST', body }); const j = await res.json(); if(!j || j.status !== 'success'){ tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">${esc(j && j.message ? j.message : 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu')}</td></tr>`; showLoader(false); return; } let items = j.data || []; items = items.filter(it => it && it.title && String(it.title).trim()); DATA = items.slice(); ALL_TITLES = Array.from(new Set(items.map(it => (it.title||'').trim()).filter(Boolean))); populateCategories(); populateUserSelects(); if(items.length === 0){ tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">Kh√¥ng c√≥ t√†i li·ªáu ng√†nh ƒë∆∞·ª£c ph√©p xem.</td></tr>`; showLoader(false); return; }

    tb.innerHTML = items.map(it=>{
      const id = esc(it.id||'');
      const title = esc(it.title||'');
      const name = esc(it.name||'');
      const urlCell = it.url ? `<a href="${esc(it.url)}" target="_blank" rel="noopener">Link</a>` : '-';
      const quyenText = resolveQuyenText(it.quyen||'');
      const djson = esc(JSON.stringify(it||{}));

      const qArr = parseQuyen(it.quyen || '');
      const uidNow = String(session.user?.id || session.user?.email || session.user?.username || '').trim();
      const canEditorModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uidNow)));

      const actionsForAdmin = `<button class="action-btn edit" data-act="edit" data-json='${djson}'>‚úè S·ª≠a</button> <button class="action-btn perm" data-act="perm" data-json='${djson}'>‚öô Quy·ªÅn</button> <button class="action-btn del" data-act="del" data-id="${id}">üóë X√≥a</button>`;
      const actionsForEditorAllowed = `<button class="action-btn edit" data-act="edit" data-json='${djson}'>‚úè S·ª≠a</button> <button class="action-btn del" data-act="del" data-id="${id}">üóë X√≥a</button>`;
      const actionsForViewer = `<button class="action-btn small view" data-act="edit" data-json='${djson}'>üëÅÔ∏è Xem</button>`;

      let actionsHtml = '';
      if(roleLower === 'admin') actionsHtml = actionsForAdmin;
      else if(roleLower === 'editor') actionsHtml = canEditorModify ? actionsForEditorAllowed : actionsForViewer;
      else actionsHtml = actionsForViewer;

      return `<tr data-id="${id}">
        <td style="max-width:120px;word-break:break-word">${id}</td>
        <td><button class="cat-badge" data-title="${title}" aria-label="M·ªü quy·ªÅn nh√≥m ${title}">${title}</button></td>
        <td class="name-cell"><div class="cell-inner" title="${name}">${name}</div></td>
        <td style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${urlCell}</td>
        <td title="${esc(it.quyen||'')}" style="white-space:nowrap">${quyenText}</td>
        <td style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"> ${actionsHtml} </td>
      </tr>`;
    }).join('');

    // mobile cards
    cardsRoot.hidden = false;
    cardsRoot.innerHTML = items.map(it => {
      const title = esc(it.title||'');
      const name = esc(it.name||'');
      const urlCell = it.url ? `<a href="${esc(it.url)}" target="_blank" rel="noopener">Link</a>` : '-';
      const quyenText = resolveQuyenText(it.quyen||'');
      const id = esc(it.id||'');
      const qArr = parseQuyen(it.quyen || '');
      const uidNow = String(session.user?.id || session.user?.email || session.user?.username || '').trim();
      const canEditorModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uidNow)));

      const actions = roleLower === 'admin' ? `<div style="display:flex;gap:8px"><button class="btn ghost" onclick="openEditFromCard('${id}')">S·ª≠a</button><button class="btn ghost" onclick="openGroupModal('${title.replace(/'/g,"\\'")}')">Quy·ªÅn</button></div>`
                    : (roleLower === 'editor' && canEditorModify) ? `<div style="display:flex;gap:8px"><button class="btn ghost" onclick="openEditFromCard('${id}')">S·ª≠a</button></div>`
                    : `<div style="display:flex;gap:8px"><button class="btn ghost" onclick="openEditFromCard('${id}')">Xem</button></div>`;

      return `<div class="card-item" role="article">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <strong><button class="cat-badge" onclick="openGroupModal('${title.replace(/'/g,"\\'")}')">${title}</button></strong>
                  <div class="muted">${urlCell}</div>
                </div>
                <div class="meta muted" style="margin-top:8px">T√™n file: ${name} ‚Ä¢ Quy·ªÅn: ${quyenText}</div>
                ${actions}
              </div>`;
    }).join('');

    attachRowListeners(); attachCatBadgeListeners();
  }catch(e){ console.error('loadDocs', e); tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`; showToast('L·ªói khi t·∫£i d·ªØ li·ªáu'); }finally{ showLoader(false); }
}

/* ========== attach row listeners for edit/delete/perm ========== */
function attachRowListeners(){ const uid = String(session.user?.id || session.user?.email || session.user?.username || '').trim(); document.querySelectorAll('button[data-act]').forEach(b=>{ const act = b.getAttribute('data-act'); b.onclick = ()=>{ if(act === 'edit' || act === 'perm'){ try{ const data = JSON.parse(b.getAttribute('data-json')); const qArr = parseQuyen(data.quyen || ''); const canModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid))); if(act === 'perm' && roleLower !== 'admin'){ alert('Ch·ªâ admin m·ªõi c√≥ th·ªÉ thay ƒë·ªïi quy·ªÅn.'); return; } const readOnly = !canModify; openEditForm(data, readOnly); }catch(e){ const readOnlyFallback = roleLower !== 'admin'; openEditForm({ id: b.dataset.id }, readOnlyFallback); } } else if(act === 'del'){ const id = b.dataset.id; const item = DATA.find(x=>String(x.id)===String(id)); const qArr = parseQuyen(item?.quyen || ''); const canDelete = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid))); if(!canDelete){ alert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a m·ª•c n√†y.'); return; } if(confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?')) deleteDoc(id); } }; }); }

/* ========== attach cat-badge click to open group modal ========== */
function attachCatBadgeListeners(){ document.querySelectorAll('.cat-badge').forEach(el=>{ el.onclick = (e) => { const title = el.getAttribute('data-title') || el.textContent || ""; if(!title) return; openGroupModal(title.trim()); }; }); }

/* ========== popup open/close (existing) ========== */
function openEditForm(item = {}, readOnly = false){ document.getElementById('ftitle').textContent = item && item.id ? (readOnly ? 'Xem t√†i li·ªáu' : 'S·ª≠a t√†i li·ªáu') : 'Th√™m t√†i li·ªáu'; document.getElementById('formState').textContent = item && item.id ? (readOnly ? 'Xem' : 'S·ª≠a') : 'M·ªõi'; fid.value = item.id || ''; if(item && item.title){ const t = String(item.title); if(t && !ALL_TITLES.includes(t)){ ALL_TITLES.unshift(t); populateCategories(); } fcategory_select.value = t; } else { fcategory_select.value = ''; } fname_inp.value = item.name || ''; fslug_inp.value = item.slug || (item.title ? slugify(item.title) : ''); furl_inp.value = item.url || ''; fquyen_all.checked = false; Array.from(fquyen_select.options).forEach(o=> o.selected = false); if(item && item.quyen){ const q = String(item.quyen).trim(); if(q.toLowerCase() === 'all'){ fquyen_all.checked = true; } else { const arr = q.split(',').map(x=>x.trim()).filter(Boolean); arr.forEach(id => { const opt = fquyen_select.querySelector(`option[value="${id}"]`); if(opt) opt.selected = true; }); } }

  // update preview
  previewQuyen.innerHTML = resolveQuyenText(item && item.quyen ? item.quyen : '');

  Array.from(document.querySelectorAll('.form input, .form select')).forEach(el => el.disabled = !!readOnly);
  if(readOnly) saveBtn.style.display = 'none'; else saveBtn.style.display = '';

  popup.style.display = 'flex'; popup.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
}
function closePopup(){ popup.style.display = 'none'; popup.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }
cancelBtn.onclick = closePopup; cancelBtnTop.onclick = closePopup;
function openEditFromCard(id){ const it = DATA.find(x=>String(x.id)===String(id)); if(it){ const qArr = parseQuyen(it.quyen || ''); const uid = String(session.user?.id || session.user?.email || session.user?.username || '').trim(); const canModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid))); openEditForm(it, !canModify); } else { openEditForm({ id }, roleLower !== 'admin'); } }

/* ========== GROUP MODAL FUNCTIONS (refined) ========== */
let currentGroupTitle = ''; let currentGroupRow = null;
function openGroupModal(title){ currentGroupTitle = title; groupNameEl.textContent = title; groupAllCheckbox.checked = false; Array.from(groupUserSelect.options).forEach(o => o.selected = false); groupFileList.innerHTML = '';

  const docs = DATA.filter(d => String(d.title || '').trim() === String(title).trim());
  currentGroupRow = DATA.find(d => String(d.title || '').trim() === String(title).trim() && (!d.name || String(d.name).trim() === ''));

  groupFileList.innerHTML = docs.map(d=>{ const id = esc(d.id||''); const name = esc(d.name||'(nh√≥m)'); return `<div class="gfile"><label style="flex:1"><input type="checkbox" class="gfile-checkbox" data-id="${id}"> ${name} <small style="color:var(--muted);">(${id})</small></label></div>`; }).join('');

  if(currentGroupRow && currentGroupRow.quyen){ const q = String(currentGroupRow.quyen).trim(); if(q.toLowerCase() === 'all'){ groupAllCheckbox.checked = true; Array.from(groupUserSelect.options).forEach(o => o.selected = false); } else { const arr = q.split(',').map(x=>x.trim()).filter(Boolean); Array.from(groupUserSelect.options).forEach(o => o.selected = arr.includes(o.value)); } }

  groupPopup.style.display = 'flex'; groupPopup.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
}
function closeGroupModal(){ groupPopup.style.display = 'none'; groupPopup.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }

/* handlers for helper buttons */
groupSelectAll.addEventListener('click', ()=> { Array.from(groupUserSelect.options).forEach(o=> o.selected = true); groupAllCheckbox.checked = false; showToast('ƒê√£ ch·ªçn t·∫•t c·∫£ user'); });
groupClearAll.addEventListener('click', ()=> { Array.from(groupUserSelect.options).forEach(o=> o.selected = false); groupAllCheckbox.checked = false; showToast('ƒê√£ b·ªè ch·ªçn user'); });
closeGroupPopup.addEventListener('click', closeGroupModal); closeGroupPopupTop.addEventListener('click', closeGroupModal);

function buildQuyenFromGroupUI(){ if(groupAllCheckbox.checked) return 'all'; const sel = Array.from(groupUserSelect.selectedOptions).map(o=>o.value).filter(Boolean); return uniqArray(sel).join(','); }

applyToGroupBtn.addEventListener('click', async ()=>{ const quyen = buildQuyenFromGroupUI(); if(!quyen){ showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 user ho·∫∑c "all"'); return; } showLoader(true); try{ if(currentGroupRow && currentGroupRow.id){ const payload = { token: session.token, id: currentGroupRow.id, title: currentGroupTitle, name: "", slug: slugify(currentGroupTitle), url: "", quyen }; const res = await fetch(API + '?route=tailieu-update', { method:'POST', body: new URLSearchParams(payload) }); const j = await res.json(); if(j && j.status === 'success'){ showToast('ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn nh√≥m'); await reloadAll(); closeGroupModal(); } else showToast(j && j.message ? j.message : 'L·ªói c·∫≠p nh·∫≠t nh√≥m'); } else { const payload = { token: session.token, title: currentGroupTitle, slug: slugify(currentGroupTitle), name: "", url: "", quyen }; const res = await fetch(API + '?route=tailieu-add', { method:'POST', body: new URLSearchParams(payload) }); const j = await res.json(); if(j && (j.status === 'success' || j.id)){ showToast('ƒê√£ t·∫°o & g√°n quy·ªÅn cho nh√≥m'); await reloadAll(); closeGroupModal(); } else showToast(j && j.message ? j.message : 'L·ªói t·∫°o nh√≥m'); } }catch(e){ console.error('applyToGroup', e); showToast('L·ªói khi √°p d·ª•ng quy·ªÅn cho nh√≥m'); }finally{ showLoader(false); } });

applyToSelectedBtn.addEventListener('click', async ()=>{ const checkedBoxes = Array.from(document.querySelectorAll('.gfile-checkbox')).filter(cb => cb.checked); if(checkedBoxes.length === 0){ showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file trong danh s√°ch b√™n tr√°i'); return; } const selectedIds = checkedBoxes.map(cb=>cb.dataset.id); const quyenToAdd = buildQuyenFromGroupUI(); if(!quyenToAdd){ showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 user ho·∫∑c "all"'); return; } if(!confirm(`√Åp d·ª•ng quy·ªÅn "${quyenToAdd}" cho ${selectedIds.length} file?`)) return; showLoader(true); try{ for(const id of selectedIds){ const doc = DATA.find(x=>String(x.id) === String(id)); if(!doc) continue; const existing = parseQuyen(doc.quyen || ''); let newArr; if(quyenToAdd === 'all') newArr = ['all']; else { newArr = uniqArray(existing.concat(quyenToAdd.split(',').map(x=>x.trim()).filter(Boolean))); } const newQuyenStr = newArr.join(','); const payload = { token: session.token, id: id, title: doc.title || currentGroupTitle, slug: doc.slug || slugify(doc.title || currentGroupTitle), name: doc.name || '', url: doc.url || '', quyen: newQuyenStr }; const res = await fetch(API + '?route=tailieu-update', { method:'POST', body: new URLSearchParams(payload) }); const j = await res.json(); if(!(j && j.status === 'success')) console.warn('update failed for', id, j); } showToast('ƒê√£ √°p d·ª•ng quy·ªÅn cho file ƒë∆∞·ª£c ch·ªçn'); await reloadAll(); closeGroupModal(); }catch(e){ console.error('applyToSelected', e); showToast('L·ªói khi √°p d·ª•ng quy·ªÅn cho file'); }finally{ showLoader(false); } });

/* ========== save & delete (kept) ========== */
async function saveDocument(){ const id = fid.value; const route = id ? 'tailieu-update' : 'tailieu-add'; let quyen = ''; if(fquyen_all.checked) quyen = 'all'; else { const sel = Array.from(fquyen_select.selectedOptions).map(o=>o.value).filter(Boolean); quyen = sel.join(','); }
  const selectedTitle = (fcategory_select.value || '').trim(); const payload = { token: session.token, id, title: selectedTitle, name: fname_inp.value.trim(), slug: fslug_inp.value.trim() || slugify(selectedTitle), url: furl_inp.value.trim(), quyen }; if(!payload.title){ showToast('Vui l√≤ng ch·ªçn danh m·ª•c (kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng)'); return; } showLoader(true); try{ const res = await fetch(API + '?route=' + route, { method:'POST', body: new URLSearchParams(payload) }); const j = await res.json(); if(j && (j.status === 'success' || j.id || j.http_status === 201)){ showToast(j.message || 'L∆∞u th√†nh c√¥ng'); closePopup(); await reloadAll(); } else showToast(j && j.message ? j.message : 'L·ªói l∆∞u d·ªØ li·ªáu'); }catch(e){ console.error('save', e); showToast('L·ªói khi l∆∞u d·ªØ li·ªáu'); }finally{ showLoader(false); } }
saveBtn.addEventListener('click', saveDocument);

async function deleteDoc(id){ const item = DATA.find(x=>String(x.id)===String(id)); const uid = String(session.user?.id || session.user?.email || session.user?.username || '').trim(); const qArr = parseQuyen(item?.quyen || ''); const canDelete = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid))); if(!canDelete){ showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a m·ª•c n√†y'); return; } showLoader(true); try{ const res = await fetch(API + '?route=tailieu-delete', { method:'POST', body: new URLSearchParams({ token: session.token, id }) }); const j = await res.json(); if(j && j.status === 'success'){ showToast(j.message || 'ƒê√£ x√≥a'); await reloadAll(); } else showToast(j && j.message ? j.message : 'L·ªói x√≥a'); }catch(e){ console.error('delete', e); showToast('L·ªói x√≥a'); }finally{ showLoader(false); } }

/* ========== small utilities & UI wiring ========== */
btnAdd.addEventListener('click', ()=> openEditForm());
btnReload.addEventListener('click', async ()=> { await reloadAll(); });
logoutBtn.addEventListener('click', ()=> { localStorage.removeItem('loggedInUser'); location.href = '/login.html'; });
clearSearch.addEventListener('click', ()=> { qInput.value=''; qInput.dispatchEvent(new Event('input')); });

qInput.addEventListener('input', ()=> { const v = qInput.value.trim().toLowerCase(); Array.from(tb.querySelectorAll('tr')).forEach(tr => { tr.style.display = tr.textContent.toLowerCase().includes(v) ? '' : 'none'; }); Array.from(cardsRoot.children).forEach(c => { c.style.display = c.textContent.toLowerCase().includes(v) ? '' : 'none'; }); });

/* ESC to close popups */
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ closePopup(); closeGroupModal(); } });

/* responsive toggle */
function updateResponsive(){ if(window.innerWidth <= 820){ document.querySelector('.table-wrap').style.display = 'none'; cardsRoot.style.display = ''; } else { document.querySelector('.table-wrap').style.display = ''; cardsRoot.style.display = 'none'; } }
window.addEventListener('resize', updateResponsive); updateResponsive();

/* ========== reload helper & bootstrap ========== */
async function reloadAll(){ showLoader(true); try{ await loadUsers(); await loadDocs(); }catch(e){ console.error(e); } finally{ showLoader(false); } }

async function bootstrap(){ try{ initAuthAndUI(); showLoader(true); await loadUsers(); await loadDocs(); }catch(e){ console.error('bootstrap', e); showToast('L·ªói kh·ªüi t·∫°o'); }finally{ showLoader(false); } }
initAuthAndUI(); bootstrap();
</script>
</body>
</html>
