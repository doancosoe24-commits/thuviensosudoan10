<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
<title>Chi ti·∫øt vƒÉn b·∫£n</title>

<style>
html, body { height: 100%; margin: 0; }
body {
  display: flex;
  flex-direction: column;
  width: 70%;
  margin: 0 auto;
  font-family: Arial, sans-serif;
  color: #333;
  background: #f7f9fb;
}
main { flex: 1; box-sizing: border-box; }

/* Title */
h2 {
  text-align: center;
  color: #004aad;
  font-weight: 700;
  padding: 0 5px;
}

/* Tabs */
.tabs-container {
  position: relative;
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid #d0d6e0;
  padding-bottom: 8px;
  margin: 0 5px;
}
.tab-btn {
  font-size: 14px;
  font-weight: 600;
  background: #004aad;
  cursor: pointer;
  padding: 10px 10px;
  border-radius: 5px;
  color: white;
  transition: 0.25s;
}
.tab-btn.active { background: #ccae6e; }
.tab-underline {
  position: absolute;
  bottom: -2px;
  height: 4px;
  background: #ccae6e;
  width: 100%;
  border-radius: 10px;
  transition: 0.3s;
}

/* Tab content */
.tab-detail {
  padding: 20px;
  background: #fff9e8;
  border-radius: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  min-height: 500px;
  position: relative;
}

/* Table */
.info-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 16px;
  border: 1px solid #000;
}
.info-table th,
.info-table td {
  text-align: left;
  padding: 12px 15px;
  border: 1px solid #000;
}
.info-table th {
  background-color: #f0f4f8;
  color: #004aad;
  width: 200px;
}

/* Watermark */
.watermark {
  position: absolute;
  top: 40%;
  left: 50%;
  font-size: 40px;
  color: rgba(200,0,0,0.15);
  transform: translate(-50%, -50%) rotate(-15deg);
  pointer-events: none;
}

@media (max-width:768px){
  body { width: 100%; }
}
 .back-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      background:#fff;
      box-shadow:0 10px 25px rgba(0,0,0,0.08);
      color:#004aad;
      font-weight:600;
      cursor:pointer;
      transition:.25s;
      margin-bottom:20px;
    }
    .back-link:hover{
      background:#004aad;
      color:#fff;
    }
</style>
</head>

<body>

<main>

  <div id="header"></div>
 <span class="back-link" onclick="history.back()">‚Üê Quay l·∫°i</span>

  <h2 id="docTitle"></h2>

  <div class="tabs-container">
    <div class="tab-btn active" data-tab="info">Thu·ªôc t√≠nh</div>
    <div class="tab-btn" data-tab="source">VƒÉn b·∫£n PDF</div>
    <div class="tab-underline"></div>
  </div>

  <div class="tab-detail" id="tabContent"></div>

</main>

<div id="footer"></div>

<script src="main.js"></script>
<script>
/* =======================================
   CONFIG
======================================= */
const webAppUrl =
  "https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec";

const slugFromURL =
  new URLSearchParams(window.location.search).get("slug") || "";

const tabContent = document.getElementById("tabContent");
const docTitle   = document.getElementById("docTitle");
const tabs       = document.querySelectorAll(".tab-btn");
const underline  = document.querySelector(".tab-underline");

let currentData = null;

/* =======================================
   NORMALIZE TITLE -> SLUG (tai-lieu-nganh)
======================================= */
function normalizeNameForComparison(text){
  return String(text || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/ƒë/g, "d")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");
}

/* =======================================
   DRIVE ID
======================================= */
function getDriveID(link){
  if (!link) return "";
  const match = link.match(/\/d\/([a-zA-Z0-9_-]+)/);
  return match ? match[1] : link;
}

/* =======================================
   TAB UNDERLINE
======================================= */
function updateUnderline(activeTab){
  if(!activeTab) return;
  underline.style.width = activeTab.offsetWidth + "px";
  underline.style.transform =
    `translateX(${activeTab.offsetLeft}px)`;
}
updateUnderline(document.querySelector(".tab-btn.active"));

/* =======================================
   FORMAT DATE
======================================= */
function formatDateVN(dateString){
  if(!dateString) return "";
  const d = new Date(dateString);
  if (isNaN(d)) return dateString;
  return `${String(d.getDate()).padStart(2,"0")}/${
    String(d.getMonth()+1).padStart(2,"0")
  }/${d.getFullYear()}`;
}

/* =======================================
   RENDER TAB
======================================= */
function showTab(data){
  if(!data) return;
  const active = document.querySelector(".tab-btn.active").dataset.tab;

  if(active === "info"){
    tabContent.innerHTML = `
      <table class="info-table">
        <tr><th>S·ªë hi·ªáu</th><td>${data.sohieu || ""}</td></tr>
        <tr><th>Ng√†y ban h√†nh</th><td>${formatDateVN(data.ngaybanhanh)}</td></tr>
        <tr><th>C∆° quan</th><td>${data.noibanhanh || ""}</td></tr>
        <tr><th>Ng∆∞·ªùi k√Ω</th><td>${data.nguoiky || ""}</td></tr>
        <tr><th>Lo·∫°i vƒÉn b·∫£n</th><td>${data.loaivanban || ""}</td></tr>
        <tr><th>Ng√†y hi·ªáu l·ª±c</th><td>${formatDateVN(data.ngayhieuluc)}</td></tr>
      </table>
    `;
  }

  if(active === "source"){
    if(!data.url){
      tabContent.innerHTML = `
        <div style="height:700px;display:flex;align-items:center;
          justify-content:center;color:#ff3131;font-size:18px;">
          D·ªØ li·ªáu PDF ch∆∞a c√≥
        </div>`;
    } else {
      const pdfID = getDriveID(data.url);
      tabContent.innerHTML = `
        <div style="height:700px;position:relative;">
          <iframe
            src="https://drive.google.com/file/d/${pdfID}/preview"
            style="width:100%;height:100%;border:none"></iframe>
          <div class="watermark">Th∆∞ vi·ªán s·ªë S∆∞ ƒëo√†n 10</div>
        </div>`;
    }
  }

  docTitle.innerText = data.title || "Kh√¥ng c√≥ ti√™u ƒë·ªÅ";
}

/* =======================================
   TAB EVENTS
======================================= */
tabs.forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelector(".tab-btn.active").classList.remove("active");
    tab.classList.add("active");
    updateUnderline(tab);
    showTab(currentData);
  };
});

/* =======================================
   LOAD DATA + COMPARE SLUG
======================================= */
if(slugFromURL){

  const slugNormalized = normalizeNameForComparison(slugFromURL);

  console.log("üîπ slugFromURL:", slugFromURL);
  console.log("üîπ slugNormalized:", slugNormalized);

  fetch(webAppUrl)
    .then(res => res.json())
    .then(res => {

      const list = res?.data?.ThuVienPhapLuatSo || [];

      console.log("üì¶ T·ªïng s·ªë b·∫£n ghi:", list.length);

      const matched = list.find(row=>{
        const titleSlug = normalizeNameForComparison(row.title);
        console.log("üî∏ compare:", titleSlug, "==", slugNormalized);
        return titleSlug === slugNormalized;
      });

      if(matched){
        currentData = matched;
        showTab(currentData);
      } else {
        docTitle.innerText = "Kh√¥ng t√¨m th·∫•y vƒÉn b·∫£n";
        tabContent.innerHTML = "<p>Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.</p>";
      }
    })
    .catch(err=>{
      console.error("‚ùå L·ªói t·∫£i d·ªØ li·ªáu:", err);
      docTitle.innerText = "L·ªói t·∫£i d·ªØ li·ªáu";
      tabContent.innerHTML = "<p>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</p>";
    });

} else {
  docTitle.innerText = "Kh√¥ng c√≥ slug";
  tabContent.innerHTML = "<p>Thi·∫øu tham s·ªë slug.</p>";
}
</script>

</body>
</html>
