<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đổi mật khẩu</title>
<style>
body{font-family:'Segoe UI',sans-serif; background:#f0f4f8; display:flex; justify-content:center; align-items:center; height:100vh;}
.card{background:#fff;padding:30px 25px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.15);width:350px;text-align:center;}
input{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #ccc;}
button{padding:12px;width:100%;border:none;border-radius:10px;background:#004aad;color:white;font-weight:700;cursor:pointer;margin-top:10px;}
.toast{position:fixed;top:-120px;left:50%;transform:translateX(-50%);padding:16px 28px;border-radius:12px;color:#fff;font-weight:700;opacity:0;transition:top 0.45s, opacity 0.45s;z-index:9999;}
.toast.show{top:22px;opacity:1;}
.toast.success{background:#28a745;}
.toast.error{background:#dc3545;}
.spinner{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<div class="card">
    <h2>Đổi mật khẩu</h2>
    <input type="password" id="tempPassword" placeholder="Mật khẩu tạm" readonly>
    <input type="password" id="newPassword" placeholder="Mật khẩu mới">
    <input type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu mới">
    <button id="btnChange">Đổi mật khẩu</button>
</div>

<div id="toast" class="toast"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec";
const toastEl = document.getElementById("toast");
function showToast(msg,type="success",duration=3500){
    toastEl.textContent = msg;
    toastEl.className = `toast ${type} show`;
    setTimeout(()=>toastEl.className='toast',duration);
}

const btn = document.getElementById("btnChange");
const tempPassEl = document.getElementById("tempPassword");
const newPassEl = document.getElementById("newPassword");
const confirmPassEl = document.getElementById("confirmPassword");

const email = sessionStorage.getItem("resetEmail");
const tempPassword = sessionStorage.getItem("resetTempPassword");
if(!email || !tempPassword){ showToast("Không có thông tin reset!", "error"); setTimeout(()=>window.location.href="login.html",1500); }
tempPassEl.value = tempPassword;

async function hashPassword(password){
    const encoder = new TextEncoder();
    const data = encoder.encode(password.trim());
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

btn.addEventListener("click", async ()=>{
    const newPass = newPassEl.value.trim();
    const confirm = confirmPassEl.value.trim();
    if(!newPass || !confirm){ showToast("Nhập đầy đủ thông tin", "error"); return; }
    if(newPass !== confirm){ showToast("Mật khẩu mới không trùng", "error"); return; }
    btn.disabled = true; btn.textContent="Đang xử lý...";
    try{
        const hashed = await hashPassword(newPass);
        const resp = await fetch(`${API}?action=changepassword&email=${encodeURIComponent(email)}&tempPassword=${encodeURIComponent(tempPassword)}&newPassword=${hashed}`);
        const result = await resp.json();
        if(result.status!=="success"){ showToast(result.message,"error"); btn.disabled=false; btn.textContent="Đổi mật khẩu"; return; }
        showToast("Đổi mật khẩu thành công", "success");
        sessionStorage.removeItem("resetEmail");
        sessionStorage.removeItem("resetTempPassword");
        setTimeout(()=>window.location.href="login.html",1200);
    }catch(err){ console.error(err); showToast("Lỗi server","error"); btn.disabled=false; btn.textContent="Đổi mật khẩu"; }
});
</script>

</body>
</html>

