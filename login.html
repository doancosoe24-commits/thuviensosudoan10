<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
    <title>Đăng nhập</title>

    <style>
        :root{
            --primary:#004aad;
            --secondary:#f5b042;
            --success:#28a745;
            --error:#dc3545;
            --bg:#f0f4f8;
            --input-bg:#ffffffcc;
            --text-dark:#08304a;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
        body{height:100vh;display:flex;justify-content:center;align-items:center;background:var(--bg);}
        .login-card{background:#fff;padding:40px 30px;border-radius:16px;width:360px;box-shadow:0 10px 25px rgba(0,0,0,0.1);text-align:center;transition: transform 0.3s ease;}
        .login-card:hover{transform: translateY(-5px);}
        .login-card h2{margin-bottom:24px;color:var(--primary);font-size:28px;}
        .input-group{margin-bottom:16px;text-align:left;}
        .input-group input{width:100%;padding:14px;border-radius:8px;border:1px solid #ccc;background:var(--input-bg);font-size:16px;color:var(--text-dark);transition: border 0.3s;}
        .input-group input:focus{border-color:var(--primary);outline:none;}
        .btn-auth{width:100%;padding:14px;border:none;border-radius:10px;font-weight:700;font-size:16px;cursor:pointer;background:linear-gradient(90deg,var(--secondary),#ffd86b);color:var(--text-dark);transition: transform 0.2s, box-shadow 0.2s;}
        .btn-auth:hover{transform: translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
        .login-footer{margin-top:18px;font-size:14px;color:#555;}
        .login-footer a{color:var(--primary);text-decoration:none;font-weight:600;}
        .login-footer a:hover{text-decoration:underline;}
        .toast{position:fixed;top:-120px;left:50%;transform:translateX(-50%);padding:16px 28px;border-radius:12px;color:#fff;font-weight:700;opacity:0;transition:top 0.45s, opacity 0.45s;z-index:9999;font-size:14px;}
        .toast.show{top:22px;opacity:1;}
        .toast.success{background:var(--success);}
        .toast.error{background:var(--error);}
        .spinner{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;animation:spin 0.8s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        /* forgot popup */
        #forgotBox{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:99999;}
        .forgot-card{background:#fff;width:330px;padding:25px;border-radius:14px;box-shadow:0 8px 25px rgba(0,0,0,0.2);text-align:center;}
        .forgot-card input{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;background:#fafafa;margin-bottom:15px;}
        .btn-forgot{padding:12px;width:100%;border:none;border-radius:10px;background:var(--primary);color:white;font-weight:700;cursor:pointer;}
        .btn-close{margin-top:12px;background:#999;}
        .small-note{font-size:13px;color:#666;margin-top:8px;}
    </style>
</head>

<body>

    <div id="toast" class="toast"></div>

    <!-- POPUP QUÊN MẬT KHẨU -->
    <div id="forgotBox">
        <div class="forgot-card">
            <h3 style="margin-bottom:15px;color:var(--primary)">Quên mật khẩu</h3>
            <input type="email" id="forgotEmail" placeholder="Nhập email đăng ký">
            <button class="btn-forgot" id="sendForgot">Xác nhận</button>
            <button class="btn-forgot btn-close" id="closeForgot">Đóng</button>
            <div class="small-note">
                Nếu email hợp lệ, mật khẩu tạm thời sẽ được trả về (API) và bạn có thể gửi email với EmailJS.
            </div>
        </div>
    </div>

    <div class="login-card">
        <img style="width: 120px;" src="./img/logo.png" alt="">
        <h2>Đăng nhập</h2>

        <form id="loginForm" autocomplete="off">
            <div class="input-group">
                <input type="text" id="username" placeholder="Tài khoản" required autocomplete="username">
            </div>

            <div class="input-group">
                <input type="password" id="password" placeholder="Mật khẩu" required autocomplete="current-password">
            </div>

            <button type="submit" class="btn-auth" id="btnAuth">Đăng nhập</button>
        </form>

        <div class="login-footer" style="margin-top:10px;">
            <a href="./forgot.html" >Quên mật khẩu?</a>
        </div>

        <div class="login-footer">
            Chưa có tài khoản? <a href="register.html">Đăng ký</a>
        </div>
    </div>

    <!-- EmailJS (tuỳ chọn) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        /* ================== CẤU HÌNH ==================
           * Thay URL API phía dưới bằng URL WebApp (Apps Script) bạn đã deploy
        */
        const API = "https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec"; // <-- thay bằng WebApp URL của bạn

        // EmailJS init (nếu dùng) - thay bằng khoá của bạn nếu muốn
        const USE_EMAILJS = false; // chuyển true nếu enable
        const EMAILJS_USER = "REPLACE_EMAILJS_USER"; // emailjs.init(...)
        const EMAIL_SERVICE = "service_6uvpvzl";
        const EMAIL_TEMPLATE = "template_ov4mk2f";
        if(USE_EMAILJS && EMAILJS_USER && window.emailjs) emailjs.init(EMAILJS_USER);

        /* ================== UI HELPERS ================== */
        const toastEl = document.getElementById("toast");
        function showToast(msg,type="success",duration=3500){
            toastEl.textContent = msg;
            toastEl.className = `toast ${type} show`;
            setTimeout(()=>{ toastEl.className='toast'; }, duration);
        }
        function showForgot(){ document.getElementById("forgotBox").style.display = "flex"; }
        function hideForgot(){ document.getElementById("forgotBox").style.display = "none"; }
        const btnAuth = document.getElementById("btnAuth");
        function setLoading(is){ btnAuth.disabled = is; btnAuth.innerHTML = is ? '<span class="spinner"></span> Đang xử lý...' : 'Đăng nhập'; }

        
        /* ================== Helper: fetch JSON with timeout ================== */
        function fetchJson(url, options, timeout = 20000){
            return new Promise((resolve, reject) => {
                const timer = setTimeout(()=> reject(new Error("Timeout")), timeout);
                fetch(url, options).then(r => {
                    clearTimeout(timer);
                    return r.text();
                }).then(t => {
                    try { resolve(JSON.parse(t)); }
                    catch(e){ reject(new Error("Invalid JSON response")); }
                }).catch(err => {
                    clearTimeout(timer);
                    reject(err);
                });
            });
        }

        /* ================== Helper: get public IP (with timeout) ================== */
        async function getPublicIP(timeout = 2500){
            try{
                const controller = new AbortController();
                const id = setTimeout(()=> controller.abort(), timeout);
                const res = await fetch('https://api.ipify.org?format=json', { signal: controller.signal });
                clearTimeout(id);
                if(!res.ok) return "";
                const j = await res.json();
                return j.ip || "";
            }catch(e){
                return ""; // fallback empty
            }
        }

        /* ================== Helper: detect device string ================== */
        function detectDevice(){
            const ua = navigator.userAgent || navigator.vendor || window.opera || "";
            const lower = ua.toLowerCase();
            if(/android/.test(lower)) return "Android: " + ua;
            if(/iphone|ipad|ipod/.test(lower)) return "iOS: " + ua;
            if(/windows phone/.test(lower)) return "WindowsPhone: " + ua;
            // desktop hints
            if(/windows nt/.test(lower)) return "Windows: " + ua;
            if(/macintosh|mac os x/.test(lower)) return "Mac: " + ua;
            return "Browser: " + ua;
        }

        /* ================== LOGIN FLOW ================== */
        document.getElementById("loginForm").addEventListener("submit", async (e)=>{
            e.preventDefault();
            const username = (document.getElementById("username").value || "").trim();
            const password = (document.getElementById("password").value || "");
            if(!username || !password){ showToast("Nhập đầy đủ thông tin", "error"); return; }

            setLoading(true);

            try{
                // lấy ip (song song, chờ tối đa 2s)
                const ipPromise = getPublicIP(2000);
                const deviceStr = detectDevice();

                const ip = await ipPromise; // nếu timeout -> ""

                // chuẩn bị body form-urlencoded (Apps Script parseBody hỗ trợ)
                const body = new URLSearchParams();
                body.append('route', 'login');                 // bắt buộc match server
                body.append('username', username);
                body.append('password', password);
                if(ip) body.append('ip', ip);                  // server dùng field ip
                if(deviceStr) body.append('loaithietbi', deviceStr); // server dùng loaithietbi

                const result = await fetchJson(API, { method: "POST", body: body }, 20000);

                // apps script trả { status:"success" | "error", message: "...", token, user, isAdmin }
                const ok = (result && (result.status === "success" || result.success === true));
                if(!ok){
                    // server có thể trả message rõ ràng
                    const m = (result && (result.message || result.error)) ? (result.message || result.error) : "Đăng nhập thất bại";
                    showToast(m, "error");
                    setLoading(false);
                    return;
                }

                // success
                const token = result.token || null;
                const userFromResp = result.user || null;

                const user = userFromResp ? {
                    id: userFromResp.id || null,
                    username: userFromResp.username || username,
                    role: (userFromResp.role || "").toString(),
                    can_view: userFromResp.can_view || ""
                } : { id: null, username: username, role: (result.role||"user"), can_view: "" };

                // lưu local storage
                const loggedObj = { token: token, user: user, loginAt: Date.now() };
                try{ localStorage.setItem("loggedInUser", JSON.stringify(loggedObj)); }catch(e){ console.warn("localStorage error", e); }

                if(!token){
                    // trường hợp bất thường: server cho success nhưng không trả token
                    showToast("Đăng nhập thành công nhưng không có token", "error");
                    setLoading(false);
                    return;
                }

                // kiểm tra quyền (check-manager) để điều hướng
                try{
                    const checkBody = new URLSearchParams();
                    checkBody.append('route','check-manager');
                    checkBody.append('token', token);
                    const checkRes = await fetchJson(API, { method: "POST", body: checkBody }, 10000);

                    const isManager = !!(checkRes && checkRes.isManager);
                    // nếu server trả user chi tiết, cập nhật lại local
                    if(checkRes && checkRes.user){
                        loggedObj.user.id = checkRes.user.id || loggedObj.user.id;
                        loggedObj.user.username = checkRes.user.username || loggedObj.user.username;
                        loggedObj.user.role = checkRes.user.role || loggedObj.user.role;
                        try{ localStorage.setItem("loggedInUser", JSON.stringify(loggedObj)); }catch(e){}
                    }

                    showToast(result.message || "Đăng nhập thành công", "success");

                    setTimeout(()=> {
                        if(isManager){
                            window.location.href = "index.html";
                        } else {
                            window.location.href = "index.html";
                        }
                    }, 600);
                    return;

                }catch(err){
                    // nếu check-manager lỗi => redirect về main (an toàn)
                    console.warn("check-manager lỗi:", err);
                    showToast("Đăng nhập thành công (không kiểm tra quyền).", "success");
                    setTimeout(()=> window.location.href = "index.html", 600);
                    return;
                }

            }catch(err){
                console.error("Login error:", err);
                showToast("Lỗi kết nối server", "error");
            } finally {
                setLoading(false);
            }
        });

        /* ================== FORGOT PASSWORD FLOW ================== */
        document.getElementById("forgotLink").addEventListener("click", (e)=>{ e.preventDefault(); showForgot(); });
        document.getElementById("closeForgot").addEventListener("click", (e)=>{ e.preventDefault(); hideForgot(); });

        document.getElementById("sendForgot").addEventListener("click", async ()=>{
            const email = (document.getElementById("forgotEmail").value || "").trim();
            if(!email){ showToast("Vui lòng nhập email!", "error"); return; }

            try{
                // gọi GET ?action=forgotpassword&email=...
                const url = `${API}?action=forgotpassword&email=${encodeURIComponent(email)}`;
                const result = await fetchJson(url, { method: "GET" }, 15000);

                const ok = (result && ((result.success === true) || (result.status && result.status === "success")));
                if(!ok){ showToast(result.message || "Email không tồn tại", "error"); return; }

                // server có thể trả password tạm trong result.password
                const tempPassword = result.password || result.tempPassword || "";

                // gửi email nếu bật EmailJS
                if(USE_EMAILJS && window.emailjs){
                    const templateParams = {
                        to_email: email,
                        password: tempPassword,
                        messageText: "Mật khẩu tạm thời của bạn. Vui lòng đổi ngay sau khi đăng nhập."
                    };
                    try{
                        await emailjs.send(EMAIL_SERVICE, EMAIL_TEMPLATE, templateParams);
                        showToast("Đã gửi mật khẩu tạm thời về email. Kiểm tra hộp thư.", "success", 4500);
                        hideForgot();
                    }catch(emailErr){
                        console.warn("EmailJS lỗi:", emailErr);
                        showToast("Không gửi được email. Mật khẩu tạm thời: " + tempPassword, "error", 7000);
                    }
                } else {
                    // hiển thị mật khẩu tạm thời trực tiếp (nếu không dùng EmailJS)
                    showToast("Mật khẩu tạm thời: " + (tempPassword || "[không có]"), "success", 7000);
                    hideForgot();
                }
            }catch(err){
                console.error("Forgot password error:", err);
                showToast("Lỗi khi gọi API quên mật khẩu", "error");
            }
        });

        /* ================== Auto-redirect if already logged in ================== */
        (function autoRedirectIfLogged(){
            try{
                const raw = localStorage.getItem("loggedInUser");
                if(!raw) return;
                const obj = JSON.parse(raw);
                if(!obj || !obj.token) return;

                // kiểm tra quyền nhanh
                const checkBody = new URLSearchParams();
                checkBody.append('route','check-manager');
                checkBody.append('token', obj.token);
                fetch(API, { method: "POST", body: checkBody }).then(r => r.text()).then(t => {
                    try{
                        const data = JSON.parse(t);
                        if(data && data.status === "success"){
                            const isManager = !!data.isManager;
                            if(isManager) window.location.href = "quanly.html";
                            else window.location.href = "index.html";
                        }
                    }catch(e){}
                }).catch(()=>{});
            }catch(e){ console.warn(e); }
        })();
    </script>

</body>
</html>
