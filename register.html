<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Đăng ký — Bước 1</title>

<!-- Favicon (nếu có) -->
<link rel="shortcut icon" href="./img/logo.png" type="image/png">

<style>
:root{
  --primary:#004aad;
  --accent:#0b6bd6;
  --bg:#f0f4f8;
  --card:#ffffff;
  --input-bg:#fff;
  --muted:#6b7a90;
  --success:#28a745;
  --danger:#dc3545;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:Inter, 'Segoe UI', Roboto, Arial, sans-serif}
html,body{height:100%}
body{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(180deg,#f6fbff, var(--bg));
  padding:20px;
}

/* Card */
.card{
  width:100%;
  max-width:420px;
  background:var(--card);
  padding:26px;
  border-radius:14px;
  box-shadow: 0 10px 30px rgba(10,30,60,0.08);
  text-align:center;
  border: 1px solid rgba(10,30,60,0.03);
}

/* Logo */
.brand {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  margin-bottom:6px;
}
.brand img{
  width:122px;
  height:122px;
  object-fit:contain;
  border-radius:14px;
  box-shadow: 0 6px 18px rgba(6,24,40,0.06);
  background: #fff;
  padding:6px;
}
.brand .sitename{
  font-size:16px;
  color:var(--primary);
  font-weight:800;
}
.brand .tag{
  font-size:12px;
  color:var(--muted);
}

/* Form */
h2{color:var(--primary);font-size:20px;margin:6px 0 12px}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid #e1e8f0;background:var(--input-bg);margin:10px 0;font-size:15px}
.btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#4aa3ff);color:#fff;font-weight:800;cursor:pointer;font-size:15px;box-shadow:0 6px 18px rgba(11,107,214,0.12)}
.btn:active{transform:translateY(1px)}
.note{font-size:13px;color:var(--muted);margin-top:10px}
.row {display:flex; gap:8px; align-items:center; justify-content:center}

/* Tiny helpers */
.toast{position:fixed;left:50%;transform:translateX(-50%);top:20px;background:var(--success);color:#fff;padding:10px 16px;border-radius:8px;display:none;z-index:9999;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
.toast.error{background:var(--danger)}
.small{font-size:13px;color:#8a98ad}

/* Responsive */
@media (max-width:420px){
  .card{padding:18px}
  .brand img{width:78px;height:78px}
}
</style>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script> (function(){ emailjs.init('aL-gGjOA0UWePMm7O'); })(); </script>
</head>
<body>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<div class="card" role="region" aria-label="Form đăng ký">
  <div class="brand" aria-hidden="false">
    <!-- LOGO: đặt file logo của bạn tại ./img/logo.png -->
    <img src="./img/logo.png" alt="Logo — Thư viện số Trung đoàn 24" />
  </div>

  <h2>Tạo tài khoản</h2>

  <label for="username" class="small" style="display:block;text-align:left;margin-bottom:6px;color:#425b76">Tên đăng nhập</label>
  <input id="username" class="input" placeholder="Tên đăng nhập" required aria-label="Tên đăng nhập">

  <label for="email" class="small" style="display:block;text-align:left;margin-bottom:6px;color:#425b76">Email</label>
  <input id="email" class="input" type="email" placeholder="Email (để nhận mã xác thực)" required aria-label="Email nhận OTP">

  <label for="password" class="small" style="display:block;text-align:left;margin-bottom:6px;color:#425b76">Mật khẩu</label>
  <input id="password" class="input" type="password" placeholder="Mật khẩu (>=6 ký tự)" required aria-label="Mật khẩu">

  <label for="password2" class="small" style="display:block;text-align:left;margin-bottom:6px;color:#425b76">Nhập lại mật khẩu</label>
  <input id="password2" class="input" type="password" placeholder="Nhập lại mật khẩu" required aria-label="Nhập lại mật khẩu">

  <button id="btnSend" class="btn" aria-label="Đăng ký và gửi mã">Đăng ký & Gửi mã xác thực</button>

  <div class="note">Bạn sẽ nhận mã OTP trong email để kích hoạt tài khoản.</div>
  <div style="margin-top:12px;font-size:13px;color:#8a98ad">Đã có tài khoản? <a href="index.html" style="color:var(--accent);text-decoration:none;font-weight:700">Đăng nhập</a></div>
</div>

<script>
/* ========== Cấu hình ========== */
const EMAILJS_SERVICE_ID = 'service_teretkd';
const EMAILJS_TEMPLATE_ID = 'template_vtpddn4';
const API = 'https://script.google.com/macros/s/AKfycbxPWbbwdGjo3VrbBfzlzCcpGfqCQ7aNHLCsjkzTKdp7h7flB34JZKbsDGZ11l8si0PpHA/exec';

/* ========== Helpers UI ========== */
const toastEl = document.getElementById('toast');
function showToast(text, type='success', ms=2800){
  toastEl.textContent = text;
  toastEl.className = 'toast' + (type==='error' ? ' error' : '');
  toastEl.style.display = 'block';
  setTimeout(()=>{ toastEl.style.display = 'none'; }, ms);
}

/* ========== simple sha256 ========= */
async function sha256(s){
  const enc = new TextEncoder();
  const b = enc.encode(s);
  const h = await crypto.subtle.digest('SHA-256', b);
  return Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,'0')).join('');
}

/* ========== localStorage helpers ========== */
function savePendingRegistration(obj){ localStorage.setItem('pending_registration', JSON.stringify(obj)); }
function saveOtpLocal(email, otp){ const rec={email,otp,exp: Date.now()+5*60*1000}; localStorage.setItem('pending_otp', JSON.stringify(rec)); }
function getLastSent(){ const v = localStorage.getItem('otp_last_sent'); return v ? Number(v) : 0; }
function setLastSent(){ localStorage.setItem('otp_last_sent', String(Date.now())); }

/* ========== send handlers: server first, fallback EmailJS ========== */
async function sendOtpViaServer(email, name, otp){
  try{
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ route:'sendOtp', email, name, otp })
    });
    if(!res.ok) throw new Error('Server trả lỗi ' + res.status);
    const j = await res.json();
    if(j && j.success) return { ok:true };
    return { ok:false, msg: j && j.message ? j.message : 'Server phản hồi không rõ' };
  }catch(err){
    console.warn('sendOtpViaServer error', err);
    return { ok:false, msg: String(err) };
  }
}
async function sendOtpViaEmailJS(email, name, otp){
  try{
    const params = {
      to_email: email,
      otp_code: otp,
      passcode: otp,
      name: name,
      time: new Date(Date.now()+5*60*1000).toLocaleString('vi-VN')
    };
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
    return { ok:true };
  }catch(err){
    console.error('EmailJS send error', err);
    return { ok:false, msg: String(err) };
  }
}

/* ========== Main ========== */
document.getElementById('btnSend').addEventListener('click', async ()=>{
  const username = document.getElementById('username').value.trim();
  const email = document.getElementById('email').value.trim().toLowerCase();
  const password = document.getElementById('password').value;
  const password2 = document.getElementById('password2').value;

  if(!username || !email || !password || !password2){
    showToast('Nhập đầy đủ thông tin', 'error'); return;
  }
  if(password !== password2){
    showToast('Mật khẩu không khớp', 'error'); return;
  }
  if(password.length < 6){
    showToast('Mật khẩu tối thiểu 6 ký tự', 'error'); return;
  }
  if(Date.now() - getLastSent() < 60*1000){
    showToast('Vui lòng chờ trước khi gửi lại', 'error'); return;
  }

  try{
    // Hash mật khẩu client-side trước khi lưu pending (tùy server bạn có yêu cầu hay không)
    savePendingRegistration({ username, email, passwordHash: password });

    // tạo OTP và lưu local
    const otp = String(Math.floor(100000 + Math.random()*900000));
    saveOtpLocal(email, otp);
    setLastSent();

    // ưu tiên gửi qua server (nếu bạn đã deploy Apps Script sendOtp handler)
    const srv = await sendOtpViaServer(email, username, otp);
    if(srv.ok){
      showToast('OTP đã gửi qua server. Chuyển tới trang xác thực...', 'success');
      setTimeout(()=> location.href = 'register_email-verify.html', 900);
      return;
    }

    // fallback EmailJS (client)
    const js = await sendOtpViaEmailJS(email, username, otp);
    if(js.ok){
      showToast('OTP đã gửi (EmailJS). Chuyển tới trang xác thực...', 'success');
      setTimeout(()=> location.href = 'register_email-verify.html', 900);
      return;
    }

    showToast('Gửi OTP thất bại: ' + (srv.msg || js.msg || 'Không rõ'), 'error');
  }catch(err){
    console.error(err);
    showToast('Gửi OTP thất bại', 'error');
  }
});
</script>
</body>
</html>
